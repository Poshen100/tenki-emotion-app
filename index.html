<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TENKI v10.5</title>
    <script src="https://cdn.jsdelivr.net/npm/three@r128/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@r128/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4.1633559619/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.4.1633559619/camera_utils.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #131729 100%);
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
        }
        .container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: rgba(10, 14, 39, 0.95);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0, 212, 255, 0.2);
        }
        .logo {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(90deg, #00d4ff, #9d4edd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .btn {
            padding: 10px 20px;
            background: linear-gradient(90deg, #00d4ff, #9d4edd);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }
        .main {
            flex: 1;
            display: flex;
        }
        .video-section {
            flex: 1;
            background: #000;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            display: none;
        }
        #canvas {
            width: 100%;
            height: 100%;
        }
        .sidebar {
            width: 350px;
            background: rgba(10, 14, 39, 0.95);
            border-left: 1px solid rgba(0, 212, 255, 0.2);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }
        .section-title {
            font-size: 12px;
            font-weight: bold;
            color: #00d4ff;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            border-bottom: 2px solid rgba(0, 212, 255, 0.3);
            padding-bottom: 8px;
        }
        .info-panel {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            padding: 16px;
        }
        .info-label {
            color: #00d4ff;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .info-value {
            color: #e0e0e0;
            font-size: 18px;
        }
        .fps-counter {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #00d4ff;
            border-radius: 8px;
            padding: 10px 15px;
            font-family: monospace;
            font-size: 12px;
            color: #00d4ff;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">TENKI v10.5</div>
            <button class="btn" onclick="startCamera()">ðŸŽ¥ å•Ÿå‹•ç›¸æ©Ÿ</button>
        </div>
        <div class="main">
            <div class="video-section">
                <video id="video"></video>
                <canvas id="canvas"></canvas>
                <div class="fps-counter" id="fpsCounter">FPS: 0</div>
            </div>
            <div class="sidebar">
                <div>
                    <div class="section-title">ðŸ“Š è¿½è¹¤ç‹€æ…‹</div>
                    <div class="info-panel">
                        <div class="info-label">æª¢æ¸¬é»žæ•¸</div>
                        <div class="info-value" id="landmarkCount">0 / 468</div>
                    </div>
                </div>
                <div>
                    <div class="section-title">âš¡ æ€§èƒ½æŒ‡æ¨™</div>
                    <div class="info-panel">
                        <div class="info-label">å¹€çŽ‡ (FPS)</div>
                        <div class="info-value" id="fpsDisplay">0 FPS</div>
                    </div>
                </div>
                <div>
                    <div class="section-title">ðŸ’« ç³»çµ±ç‹€æ…‹</div>
                    <div class="info-panel">
                        <div class="info-label">ç‹€æ…‹</div>
                        <div class="info-value" id="systemStatus">å°±ç·’</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let scene, camera, renderer, maskModel;
        let faceMesh = null;
        let fps = 0, frameCount = 0, lastTime = Date.now();

        // Three.js åˆå§‹åŒ–
        function initThree() {
            const canvas = document.getElementById('canvas');
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            camera.position.z = 2;

            renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.setClearColor(0x000000, 0);

            // å…‰æº
            const light1 = new THREE.DirectionalLight(0xffffff, 0.8);
            light1.position.set(1, 1, 1);
            scene.add(light1);

            const light2 = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(light2);

            loadModel();
        }

        // åŠ è¼‰ GLB æ¨¡åž‹
        async function loadModel() {
            try {
                const loader = new THREE.GLTFLoader();
                const gltf = await loader.load('./0_Monochrome_portrait_of_a_serious_man_Hunyuan_3D_a0e932ca(1).glb');
                maskModel = gltf.scene;
                maskModel.traverse(child => {
                    if (child.isMesh) {
                        child.material = new THREE.MeshStandardMaterial({
                            color: 0xe0e0e0,
                            metalness: 0.3,
                            roughness: 0.7
                        });
                    }
                });
                scene.add(maskModel);
                document.getElementById('systemStatus').textContent = 'âœ… 3D æ¨¡åž‹å·²è¼‰å…¥';
            } catch (error) {
                console.warn('GLB è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨çƒé«”');
                const geo = new THREE.SphereGeometry(1, 32, 32);
                const mat = new THREE.MeshStandardMaterial({ color: 0xe0e0e0 });
                maskModel = new THREE.Mesh(geo, mat);
                scene.add(maskModel);
            }
        }

        // åˆå§‹åŒ– Face Mesh
        async function initFaceMesh() {
            faceMesh = new FaceMesh({
                locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
            });
            faceMesh.setOptions({
                maxNumFaces: 1,
                refineLandmarks: true,
                minDetectionConfidence: 0.7,
                minTrackingConfidence: 0.7
            });
            faceMesh.onResults(onResults);
        }

        function onResults(results) {
            if (!results.multiFaceLandmarks || results.multiFaceLandmarks.length === 0) {
                document.getElementById('landmarkCount').textContent = '0 / 468';
                return;
            }
            const landmarks = results.multiFaceLandmarks[0];
            document.getElementById('landmarkCount').textContent = `${landmarks.length} / 468`;

            if (maskModel && landmarks.length > 0) {
                const left = landmarks[33];
                const right = landmarks[263];
                const nose = landmarks[1];
                const centerX = (left.x + right.x) / 2;
                const centerY = (left.y + right.y) / 2;
                const centerZ = (left.z + right.z) / 2;

                maskModel.position.x = (centerX - 0.5) * 2;
                maskModel.position.y = (0.5 - centerY) * 2;
                maskModel.position.z = centerZ * -10;

                const yaw = Math.atan2(nose.x - centerX, 0.05);
                const pitch = (centerY - nose.y) * 100;
                const roll = Math.atan2(right.y - left.y, right.x - left.x);

                maskModel.rotation.x = pitch * (Math.PI / 180);
                maskModel.rotation.y = yaw;
                maskModel.rotation.z = roll;

                const faceWidth = Math.abs(left.x - right.x);
                const scale = faceWidth * 10;
                maskModel.scale.set(Math.max(0.5, Math.min(2, scale)), Math.max(0.5, Math.min(2, scale)), Math.max(0.5, Math.min(2, scale)));
            }
        }

        // å•Ÿå‹•ç›¸æ©Ÿ
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: 'user' },
                    audio: false
                });
                const video = document.getElementById('video');
                video.srcObject = stream;
                video.play();

                await initFaceMesh();

                async function process() {
                    if (video.readyState === video.HAVE_ENOUGH_DATA) {
                        await faceMesh.send({ image: video });
                        updateFPS();
                        renderer.render(scene, camera);
                    }
                    requestAnimationFrame(process);
                }
                process();
                document.getElementById('systemStatus').textContent = 'âœ… ç›¸æ©Ÿé‹è¡Œä¸­';
            } catch (error) {
                document.getElementById('systemStatus').textContent = 'âŒ ç›¸æ©ŸéŒ¯èª¤';
            }
        }

        function updateFPS() {
            frameCount++;
            const now = Date.now();
            const delta = (now - lastTime) / 1000;
            if (delta >= 1) {
                fps = frameCount;
                frameCount = 0;
                lastTime = now;
                document.getElementById('fpsCounter').textContent = `FPS: ${fps}`;
                document.getElementById('fpsDisplay').textContent = `${fps} FPS`;
            }
        }

        window.addEventListener('resize', () => {
            if (renderer) {
                const w = document.getElementById('canvas').clientWidth;
                const h = document.getElementById('canvas').clientHeight;
                camera.aspect = w / h;
                camera.updateProjectionMatrix();
                renderer.setSize(w, h);
            }
        });

        document.addEventListener('DOMContentLoaded', initThree);
    </script>
</body>
</html>
