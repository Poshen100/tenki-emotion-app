<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TENKI v19.0 - Stardust Soul</title>
    
    <!-- Core Engine -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    
    <!-- UI / Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root { --bg-deep: #000000; --soul-cyan: #00F0FF; --soul-green: #00FF88; --soul-red: #FF3333; --soul-purple: #9966FF; }
        body {
            background: var(--bg-deep); color: white; font-family: 'Courier New', monospace;
            width: 100vw; height: 100dvh; position: fixed; margin: 0; padding: 0; touch-action: none; overflow: hidden;
        }
        
        /* Ghost Protocol */
        #input-video { position: fixed; top: -9999px; left: -9999px; opacity: 0; pointer-events: none; }
        
        /* Layers */
        .layer { position: absolute; inset: 0; transition: opacity 0.5s ease, transform 0.5s ease; pointer-events: none; opacity: 0; display: flex; flex-direction: column; }
        .layer.active { pointer-events: auto; opacity: 1; z-index: 10; }
        
        /* 3D Universe */
        #universe { position: absolute; inset: 0; z-index: 1; background: radial-gradient(circle at center, #0b1016 0%, #000000 100%); }

        /* UI Elements */
        .glass-panel { background: rgba(16, 20, 35, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; }
        .btn-primary { background: var(--soul-cyan); color: black; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; padding: 12px 24px; border: none; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px); transition: all 0.2s; }
        .btn-primary:active { transform: scale(0.95); background: white; }
        
        /* ERI Gauge */
        .eri-gauge-container { width: 200px; height: 100px; position: relative; overflow: hidden; margin: 0 auto; }
        .eri-gauge-arc { width: 200px; height: 200px; border-radius: 50%; border: 15px solid rgba(255,255,255,0.1); border-top-color: var(--soul-green); border-right-color: transparent; border-bottom-color: transparent; border-left-color: var(--soul-green); transform: rotate(-45deg); transition: transform 1s ease, border-color 0.5s ease; }
        
        /* Mini Stats Grid */
        .stat-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; margin-top: 10px; }
        .stat-cell { background: rgba(42,58,74,0.4); border: 1px solid #2a3a4a; padding: 8px 2px; text-align: center; border-radius: 4px; }
        
        /* Timer Ring */
        .timer-ring circle { transition: stroke-dashoffset 1s linear, stroke 0.3s ease; transform: rotate(-90deg); transform-origin: 50% 50%; }

        /* Fingerprint */
        .fingerprint-sensor { width: 80px; height: 80px; border-radius: 50%; border: 1px solid rgba(0, 240, 255, 0.3); display: flex; justify-content: center; align-items: center; transition: all 0.3s; margin: 0 auto; }
        .fingerprint-sensor.scanning { border-color: var(--soul-cyan); box-shadow: 0 0 30px var(--soul-cyan); animation: pulse 1s infinite; }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }

        /* FBD Dot */
        .fbd-dot { position: fixed; bottom: 30px; right: 30px; width: 16px; height: 16px; background: var(--soul-purple); border-radius: 50%; box-shadow: 0 0 15px var(--soul-purple); animation: fbd-breathe 2s infinite; z-index: 99; display: none; }
        @keyframes fbd-breathe { 0%, 100% { opacity: 0.5; transform: scale(1); } 50% { opacity: 1; transform: scale(1.3); } }
    </style>
</head>
<body>

    <video id="input-video" playsinline webkit-playsinline></video>

    <!-- Background Layer -->
    <div id="universe"></div>

    <!-- 1. SPLASH / DISCLAIMER -->
    <div id="layer-disclaimer" class="layer active z-50 bg-black/90 p-8 justify-center items-center text-center">
        <div class="text-2xl font-bold tracking-[6px] mb-2 text-white">TENKI v19.0</div>
        <div class="text-xs text-cyan-400 tracking-widest mb-10">STARDUST SOUL</div>
        
        <div class="glass-panel p-6 mb-8 text-left text-xs leading-relaxed text-gray-300">
            <div class="text-yellow-400 font-bold mb-2">‚ö†Ô∏è DISCLAIMER</div>
            <p class="mb-2">This app is for trading psychology & self-awareness only. Not medical advice.</p>
            <p>Your biometric data is processed locally via WebAssembly and never leaves this device.</p>
        </div>
        
        <button id="btn-agree" class="btn-primary w-full max-w-xs">I UNDERSTAND & BEGIN</button>
    </div>

    <!-- 2. HOME DASHBOARD -->
    <div id="layer-dashboard" class="layer p-6 pt-12">
        <div class="flex justify-between items-center mb-8">
            <div class="text-lg font-bold">TENKI v19.0</div>
            <div class="text-[10px] bg-gray-800 px-2 py-1 rounded text-green-400">SECURE ‚úì</div>
        </div>

        <!-- ERI Gauge -->
        <div class="flex flex-col items-center mb-8">
            <div class="text-xs tracking-widest text-gray-400 mb-2">ERI SCORE</div>
            <div class="eri-gauge-container">
                <div id="dash-gauge" class="eri-gauge-arc"></div>
            </div>
            <div class="text-5xl font-bold -mt-16 text-white" id="dash-score">--</div>
            <div class="text-sm tracking-[4px] mt-2 text-green-400" id="dash-status">STANDBY</div>
        </div>

        <!-- Strategy Card -->
        <div class="glass-panel p-4 mb-6">
            <div class="text-[10px] text-gray-400 uppercase mb-2 border-b border-gray-700 pb-1">Allowed Strategy</div>
            <div id="strategy-list" class="space-y-2 text-xs">
                <div class="flex items-center text-gray-500">Waiting for scan...</div>
            </div>
        </div>

        <!-- Actions -->
        <div class="mt-auto grid grid-cols-2 gap-4">
            <button onclick="App.switchLayer('layer-scan-select')" class="glass-panel p-4 text-center active:bg-white/10">
                <i data-lucide="scan" class="w-6 h-6 mx-auto mb-2 text-cyan-400"></i>
                <div class="text-[10px] tracking-widest">SCAN ERI</div>
            </button>
            <button onclick="App.startTimer()" class="glass-panel p-4 text-center active:bg-white/10">
                <i data-lucide="timer" class="w-6 h-6 mx-auto mb-2 text-yellow-400"></i>
                <div class="text-[10px] tracking-widest">TIMER</div>
            </button>
        </div>
    </div>

    <!-- 3. SCAN SELECT -->
    <div id="layer-scan-select" class="layer p-6 pt-20 justify-center space-y-6">
        <div class="text-center text-xs tracking-widest mb-4">SELECT SCAN MODE</div>
        
        <div onclick="App.startScan('quick')" class="glass-panel p-6 active:scale-95 transition-transform cursor-pointer">
            <div class="flex justify-between mb-2">
                <div class="font-bold text-cyan-400">üöÄ QUICK SCAN</div>
                <div class="text-xs">2 SEC</div>
            </div>
            <div class="text-[10px] text-gray-400 leading-relaxed">
                ‚Ä¢ Face Detection<br>‚Ä¢ Mouth Analysis<br>‚Ä¢ Head Rotation
            </div>
        </div>

        <div onclick="App.startScan('enhanced')" class="glass-panel p-6 active:scale-95 transition-transform cursor-pointer border-cyan-500/30">
            <div class="flex justify-between mb-2">
                <div class="font-bold text-purple-400">üî¨ ENHANCED</div>
                <div class="text-xs">15 SEC</div>
            </div>
            <div class="text-[10px] text-gray-400 leading-relaxed">
                ‚Ä¢ Multi-angle FAU<br>‚Ä¢ rPPG Heart Rate<br>‚Ä¢ Breathing Analysis
            </div>
        </div>
        
        <button onclick="App.switchLayer('layer-dashboard')" class="text-xs text-gray-500 mt-8 text-center w-full">CANCEL</button>
    </div>

    <!-- 4. SCANNING (Visual Only) -->
    <div id="layer-scanning" class="layer justify-center items-center">
        <div class="absolute top-20 text-xs tracking-[4px] text-cyan-400 animate-pulse">ANALYZING SOUL...</div>
        
        <div id="scan-btn" class="fingerprint-sensor glass-panel">
            <i data-lucide="fingerprint" class="w-8 h-8 text-white"></i>
        </div>
        
        <div class="mt-8 text-center">
            <div class="text-[10px] text-gray-500 mb-2" id="scan-instruction">HOLD TO SCAN</div>
            <div class="w-48 h-1 bg-gray-800 rounded-full overflow-hidden mx-auto">
                <div id="scan-progress" class="h-full bg-cyan-400 w-0 transition-all duration-75"></div>
            </div>
        </div>
    </div>

    <!-- 5. RESULT PANEL -->
    <div id="layer-result" class="layer justify-end pb-10 px-6">
        <div class="glass-panel p-6 mb-4 animate-in slide-in-from-bottom-10 fade-in duration-500">
            <div class="text-center mb-6">
                <div class="text-[10px] tracking-widest text-gray-400 mb-1">ERI SCORE</div>
                <div id="res-score" class="text-6xl font-bold text-white mb-2">--</div>
                <div id="res-status" class="inline-block px-3 py-1 rounded text-[10px] font-bold bg-gray-800 text-white">CALCULATING</div>
            </div>

            <!-- Mini Stats -->
            <div class="stat-grid mb-6">
                <div class="stat-cell">
                    <div class="text-[8px] text-gray-400">HRV</div>
                    <div id="val-hrv" class="text-sm font-bold text-green-400">--</div>
                </div>
                <div class="stat-cell">
                    <div class="text-[8px] text-gray-400">RRI</div>
                    <div id="val-rri" class="text-sm font-bold text-white">--</div>
                </div>
                <div class="stat-cell">
                    <div class="text-[8px] text-gray-400">RESP</div>
                    <div id="val-resp" class="text-sm font-bold text-white">--</div>
                </div>
                <div class="stat-cell">
                    <div class="text-[8px] text-gray-400">ZONE</div>
                    <div id="val-zone" class="text-sm font-bold text-yellow-400">--</div>
                </div>
                <div class="stat-cell">
                    <div class="text-[8px] text-gray-400">LOAD</div>
                    <div id="val-load" class="text-sm font-bold text-red-400">--</div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <button onclick="App.confirmResult()" class="btn-primary text-xs">‚úì CONFIRM</button>
                <button onclick="App.switchLayer('layer-scan-select')" class="bg-transparent border border-gray-600 text-white text-xs py-3">RE-SCAN</button>
            </div>
        </div>
        
        <!-- AI Toast -->
        <div id="ai-toast" class="absolute bottom-40 left-1/2 -translate-x-1/2 bg-black/80 px-4 py-2 rounded border border-gray-700 text-xs text-gray-300 opacity-0 transition-opacity pointer-events-none w-64 text-center">
            AI Hint Loading...
        </div>
    </div>

    <!-- 6. MANCINI TIMER -->
    <div id="layer-timer" class="layer bg-black/90 z-50 justify-center items-center">
        <svg class="timer-ring w-64 h-64" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="45" fill="none" stroke="#1a1a1a" stroke-width="6" />
            <circle id="timer-circle" cx="50" cy="50" r="45" fill="none" stroke="#00FF88" stroke-width="6" stroke-dasharray="283" stroke-dashoffset="0" stroke-linecap="round" />
        </svg>
        
        <div class="absolute text-center">
            <div id="timer-display" class="text-5xl font-mono font-bold mb-2">03:00</div>
            <div id="timer-zone-text" class="text-xs tracking-[2px] text-green-400">SWEET SPOT</div>
        </div>

        <div id="timer-quote" class="absolute top-1/4 w-72 text-center opacity-0 transition-opacity duration-1000">
            <div class="text-xl italic text-white mb-2 font-serif">"If it's not boring,<br>it's gambling."</div>
            <div class="text-xs text-gray-500">‚Äî Adam Mancini</div>
        </div>
        
        <button onclick="App.stopTimer()" class="absolute bottom-20 text-xs text-gray-500 border border-gray-800 px-4 py-2 rounded hover:bg-white hover:text-black transition">CANCEL</button>
    </div>

    <!-- FBD Signal Dot -->
    <div id="fbd-signal" class="fbd-dot" onclick="App.startTimer()"></div>

    <!-- WORKER SCRIPT BLOB (The Engine) -->
    <script id="worker-code" type="javascript/worker">
        // --- Mock Engine for v19.0 Integration (Simulates the heavy math) ---
        // In real deployment, this contains the full FFT/rPPG logic.
        
        self.onmessage = function(e) {
            const { type, landmarks, mode } = e.data;
            if (type === 'PROCESS') {
                // Simulate processing delay and calculation
                // Real engine logic goes here
                
                // Mock calculations based on landmarks (nose position)
                const nose = landmarks[1];
                const mouthTop = landmarks[13];
                const mouthBot = landmarks[14];
                
                // Calculate simple metrics
                const openness = Math.abs(mouthTop.y - mouthBot.y) * 10;
                const movement = Math.abs(nose.x - 0.5) + Math.abs(nose.y - 0.5);
                
                // Calculate ERI (Mock Logic)
                // Stability (lower movement) + Energy (mouth)
                let eri = 50 + (openness * 100) - (movement * 100);
                eri = Math.max(10, Math.min(99, Math.floor(eri)));
                
                // Mock Bio-metrics
                const hrv = Math.floor(20 + Math.random() * 80);
                const resp = Math.floor(12 + openness * 10);
                
                self.postMessage({
                    type: 'RESULT',
                    data: {
                        eri: eri,
                        hrv: hrv,
                        resp: resp,
                        mouthOpen: openness,
                        headRot: { x: (nose.y-0.5)*2, y: (nose.x-0.5)*2 }
                    }
                });
            }
        };
    </script>

    <script>
        lucide.createIcons();

        // --- THE APP CORE ---
        const App = {
            state: {
                layer: 'layer-disclaimer',
                scanMode: null,
                isScanning: false,
                timerVal: 0,
                timerInterval: null,
                lastEri: 0
            },
            
            // WebWorker Init
            worker: null,
            initWorker: function() {
                const blob = new Blob([document.getElementById('worker-code').textContent], {type: 'text/javascript'});
                this.worker = new Worker(window.URL.createObjectURL(blob));
                this.worker.onmessage = (e) => this.handleEngineResult(e.data);
            },

            // 3D Engine (Visuals)
            three: { scene:null, camera:null, renderer:null, cloud:null, material:null },
            
            init: function() {
                this.initWorker();
                this.initThree();
                this.initAI();
                this.setupEvents();
            },

            switchLayer: function(layerId) {
                document.querySelectorAll('.layer').forEach(l => l.classList.remove('active'));
                document.getElementById(layerId).classList.add('active');
                this.state.layer = layerId;
                
                // Special handling
                if(layerId === 'layer-dashboard') this.updateDashboard();
            },

            // --- THREE.JS (Stardust Soul) ---
            initThree: function() {
                const container = document.getElementById('universe');
                this.three.scene = new THREE.Scene();
                this.three.scene.fog = new THREE.FogExp2(0x000000, 0.02);
                this.three.camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
                this.three.camera.position.z = 5;
                this.three.renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
                this.three.renderer.setSize(window.innerWidth, window.innerHeight);
                this.three.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                container.appendChild(this.three.renderer.domElement);

                // GLSL Shader
                const vertexShader = `
                    attribute float size; attribute float random; uniform float uTime; uniform float uScale; varying float vRandom;
                    void main() { vRandom = random; vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
                    gl_PointSize = (15.0 * size * uScale) * (5.0 / -mvPosition.z); gl_Position = projectionMatrix * mvPosition; }
                `;
                const fragmentShader = `
                    uniform vec3 color; varying float vRandom;
                    void main() { vec2 xy = gl_PointCoord.xy - vec2(0.5); float ll = length(xy); if(ll>0.5) discard;
                    float strength = pow((0.5-ll)*2.0, 2.0); gl_FragColor = vec4(color, strength*0.9); }
                `;

                const geometry = new THREE.BufferGeometry();
                const count = 8000;
                const positions = [], originals = [], randoms = [], sizes = [];
                const phi = Math.PI * (3. - Math.sqrt(5.));

                for (let i = 0; i < count; i++) {
                    const y = 1 - (i / (count - 1)) * 2; const radius = Math.sqrt(1 - y * y); const theta = phi * i;
                    const x = Math.cos(theta)*radius*2.5; const z = Math.sin(theta)*radius*2.5;
                    positions.push(x, y*2.5, z); originals.push(x, y*2.5, z);
                    randoms.push(Math.random()); sizes.push(0.5 + Math.random());
                }
                geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
                geometry.setAttribute('originalPosition', new THREE.Float32BufferAttribute(originals, 3));
                geometry.setAttribute('random', new THREE.Float32BufferAttribute(randoms, 1));
                geometry.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));

                this.three.material = new THREE.ShaderMaterial({
                    uniforms: { uTime: {value:0}, uScale: {value:1.0}, color: {value: new THREE.Color(0x0088ff)} },
                    vertexShader, fragmentShader, transparent: true, depthWrite: false, blending: THREE.AdditiveBlending
                });
                
                this.three.cloud = new THREE.Points(geometry, this.three.material);
                this.three.scene.add(this.three.cloud);
                this.animate();
            },

            animate: function() {
                requestAnimationFrame(() => this.animate());
                const time = Date.now() * 0.001;
                this.three.material.uniforms.uTime.value = time;
                this.three.cloud.rotation.y += 0.002;
                this.three.renderer.render(this.three.scene, this.three.camera);
            },

            // --- AI & LOGIC ---
            initAI: function() {
                const video = document.getElementById('input-video');
                const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
                faceMesh.setOptions({maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5});
                faceMesh.onResults((res) => {
                    if (res.multiFaceLandmarks && res.multiFaceLandmarks.length > 0) {
                        // Offload to Worker
                        this.worker.postMessage({ type: 'PROCESS', landmarks: res.multiFaceLandmarks[0] });
                    }
                });
                
                const camera = new Camera(video, {
                    onFrame: async () => await faceMesh.send({image: video}),
                    width: 640, height: 480
                });
                
                // Only start camera after user agrees
                this.camera = camera;
            },

            handleEngineResult: function(packet) {
                if (packet.type !== 'RESULT') return;
                const d = packet.data;
                
                // Visual Sync
                // Color shift based on ERI: Green(High) -> Blue(Mid) -> Red(Low)
                let r, g, b;
                if (d.eri > 60) { r=0; g=1; b=0.5; } // Green-ish
                else if (d.eri > 40) { r=0; g=0.5; b=1; } // Blue-ish
                else { r=1; g=0.2; b=0.2; } // Red-ish
                
                // Smoothly update shader
                this.three.material.uniforms.color.value.lerp(new THREE.Color(r, g, b), 0.1);
                this.three.material.uniforms.uScale.value = 1.0 + (d.mouthOpen * 0.5);
                
                // Rotate cloud based on head
                this.three.cloud.rotation.x = d.headRot.x * 0.5;
                this.three.cloud.rotation.y += d.headRot.y * 0.05;

                // Handle Scan Process
                if (this.state.isScanning) {
                    this.state.lastEri = d.eri; // Store for result
                    this.state.lastStats = d;
                }
            },

            // --- EVENTS & FLOW ---
            setupEvents: function() {
                // Disclaimer Button
                document.getElementById('btn-agree').addEventListener('click', () => {
                    const vid = document.getElementById('input-video');
                    if(vid.paused) vid.play().catch(e=>console.log("Autoplay blocked", e));
                    this.camera.start();
                    this.switchLayer('layer-dashboard');
                });

                // Scan Logic
                const scanBtn = document.getElementById('scan-btn');
                const startScan = (e) => {
                    e.preventDefault();
                    if(this.state.isScanning) return;
                    
                    this.state.isScanning = true;
                    scanBtn.classList.add('scanning');
                    document.getElementById('scan-instruction').innerText = "ANALYZING...";
                    if(navigator.vibrate) navigator.vibrate(50);
                    
                    const duration = this.state.scanMode === 'quick' ? 2000 : 15000;
                    const updateRate = 50;
                    let progress = 0;
                    const step = 100 / (duration / updateRate);
                    
                    const interval = setInterval(() => {
                        progress += step;
                        document.getElementById('scan-progress').style.width = `${Math.min(100, progress)}%`;
                        
                        if (progress >= 100) {
                            clearInterval(interval);
                            this.finishScan();
                        }
                    }, updateRate);
                };
                
                scanBtn.addEventListener('mousedown', startScan);
                scanBtn.addEventListener('touchstart', startScan, {passive:false});
            },

            startScan: function(mode) {
                this.state.scanMode = mode;
                this.switchLayer('layer-scanning');
                document.getElementById('scan-progress').style.width = '0%';
            },

            finishScan: function() {
                this.state.isScanning = false;
                document.getElementById('scan-btn').classList.remove('scanning');
                if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
                this.showResults();
            },

            showResults: function() {
                const d = this.state.lastStats || {eri:50, hrv:50, resp:15};
                
                // Populate DOM
                document.getElementById('res-score').innerText = d.eri;
                
                // Status Logic
                let status = "BALANCED";
                let color = "white";
                if(d.eri >= 70) { status = "HIGH ENERGY"; color = "#FF3333"; }
                else if (d.eri <= 30) { status = "LOW ENERGY"; color = "#FFFF33"; }
                
                document.getElementById('res-status').innerText = status;
                document.getElementById('res-status').style.color = color;
                
                document.getElementById('val-hrv').innerText = d.hrv;
                document.getElementById('val-resp').innerText = d.resp;
                document.getElementById('val-rri').innerText = (60000/d.hrv).toFixed(0)+"ms";
                document.getElementById('val-zone').innerText = d.eri > 60 ? "HIGH" : "ZEN";
                document.getElementById('val-load').innerText = Math.floor(d.eri * 0.8) + "%";

                this.switchLayer('layer-result');

                // AI Hint Toast
                setTimeout(() => {
                    const toast = document.getElementById('ai-toast');
                    toast.innerText = d.eri > 65 ? "‚ö†Ô∏è High Stress. FBD-Only." : "‚úì Calm. Ready for precision.";
                    toast.style.opacity = 1;
                    setTimeout(() => toast.style.opacity = 0, 2800);
                }, 500);
            },

            confirmResult: function() {
                // FBD Trigger Check
                const fbd = document.getElementById('fbd-signal');
                if (this.state.lastEri < 40) {
                    fbd.style.display = 'block';
                } else {
                    fbd.style.display = 'none';
                }
                this.switchLayer('layer-dashboard');
            },

            updateDashboard: function() {
                const score = this.state.lastEri || '--';
                document.getElementById('dash-score').innerText = score;
                
                // Update Gauge Color
                const arc = document.getElementById('dash-gauge');
                let color = '#666';
                if(score !== '--') {
                    if(score > 60) color = '#00FF88';
                    else if(score > 40) color = '#9966FF';
                    else color = '#FF3333';
                }
                arc.style.borderTopColor = color;
                arc.style.borderLeftColor = color;
                
                // Strategy List
                const list = document.getElementById('strategy-list');
                if (score === '--') return;
                
                if (score > 70) {
                    list.innerHTML = `
                        <div class="flex items-center text-green-400">‚úÖ FBD Long</div>
                        <div class="flex items-center text-red-500">‚ùå Breakout</div>
                        <div class="flex items-center text-red-500">‚ùå Reversal</div>
                    `;
                    document.getElementById('dash-status').innerText = "RESTRICTED";
                    document.getElementById('dash-status').style.color = "#FF3333";
                } else {
                    list.innerHTML = `
                        <div class="flex items-center text-green-400">‚úÖ FBD Long</div>
                        <div class="flex items-center text-green-400">‚úÖ Breakout</div>
                        <div class="flex items-center text-green-400">‚úÖ Scalp</div>
                    `;
                    document.getElementById('dash-status').innerText = "BALANCED";
                    document.getElementById('dash-status').style.color = "#00FF88";
                }
            },

            // --- TIMER LOGIC ---
            startTimer: function() {
                this.switchLayer('layer-timer');
                this.state.timerVal = 0;
                const circle = document.getElementById('timer-circle');
                const display = document.getElementById('timer-display');
                const zoneText = document.getElementById('timer-zone-text');
                const total = 180;
                
                // Quote Logic
                setTimeout(() => {
                    const q = document.getElementById('timer-quote');
                    q.style.opacity = 1;
                    setTimeout(() => q.style.opacity = 0, 2500);
                }, 175000); // Show at end (simulated logic for demo, usually at end)

                if(this.state.timerInterval) clearInterval(this.state.timerInterval);
                
                this.state.timerInterval = setInterval(() => {
                    this.state.timerVal++;
                    const val = this.state.timerVal;
                    
                    // UI Update
                    const mins = Math.floor(val / 60).toString().padStart(2,'0');
                    const secs = (val % 60).toString().padStart(2,'0');
                    display.innerText = `${mins}:${secs}`;
                    
                    // Progress Ring
                    const offset = 283 - (val / total) * 283;
                    circle.style.strokeDashoffset = offset;
                    
                    // Zone Logic
                    if (val < 60) {
                        circle.style.stroke = "#FF3333";
                        zoneText.innerText = "NO TRADE ZONE";
                        zoneText.style.color = "#FF3333";
                    } else if (val < 120) {
                        circle.style.stroke = "#FFAA00";
                        zoneText.innerText = "COOLING";
                        zoneText.style.color = "#FFAA00";
                    } else {
                        circle.style.stroke = "#00FF88";
                        zoneText.innerText = "SWEET SPOT";
                        zoneText.style.color = "#00FF88";
                    }
                    
                    if (val >= total) this.stopTimer();
                }, 1000);
            },

            stopTimer: function() {
                clearInterval(this.state.timerInterval);
                this.switchLayer('layer-dashboard');
            }
        };

        window.onload = () => App.init();
        window.onresize = () => {
            App.three.camera.aspect = window.innerWidth/window.innerHeight;
            App.three.camera.updateProjectionMatrix();
            App.three.renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>
