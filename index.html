<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TENKI v21.0 - Galaxy Bento</title>
    
    <!-- Core Engine -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    
    <!-- UI / Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- GO CLUB DESIGN SYSTEM --- */
        :root {
            --bg-deep: #050505;
            --card-bg: rgba(20, 20, 25, 0.6);
            --card-border: rgba(255, 255, 255, 0.08);
            --accent-cyan: #00F0FF;
            --accent-purple: #9D00FF;
            --accent-green: #00FF88;
            --accent-orange: #FF5500;
        }

        body {
            background: var(--bg-deep);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", sans-serif;
            width: 100vw; height: 100dvh;
            position: fixed; margin: 0; padding: 0;
            touch-action: none; overflow: hidden;
        }

        /* 3D Canvas */
        #universe { position: absolute; inset: 0; z-index: 0; pointer-events: none; }
        #input-video { position: fixed; top: -9999px; left: -9999px; opacity: 0; pointer-events: none; }

        /* Layers */
        .layer {
            position: absolute; inset: 0; z-index: 10;
            display: flex; flex-direction: column;
            padding: calc(env(safe-area-inset-top) + 20px) 24px calc(env(safe-area-inset-bottom) + 20px) 24px;
            opacity: 0; pointer-events: none; transform: scale(0.95); filter: blur(10px);
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .layer.active { opacity: 1; pointer-events: auto; transform: scale(1); filter: blur(0); }

        /* --- BENTO CARD SYSTEM (GO Club Style) --- */
        .bento-card {
            background: var(--card-bg);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--card-border);
            border-radius: 32px; /* Super rounded */
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            position: relative; overflow: hidden;
        }
        
        /* Galaxy Gradient Overlay */
        .bento-card::before {
            content: ''; position: absolute; inset: 0;
            background: radial-gradient(circle at top right, rgba(157, 0, 255, 0.15), transparent 60%),
                        radial-gradient(circle at bottom left, rgba(0, 240, 255, 0.1), transparent 60%);
            z-index: 0; pointer-events: none;
        }
        
        .card-content { position: relative; z-index: 1; height: 100%; display: flex; flex-direction: column; }

        /* Typography */
        .txt-label { font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 0.5px; }
        .txt-value { font-size: 28px; font-weight: 800; letter-spacing: -0.5px; color: white; }
        .txt-huge { font-size: 64px; font-weight: 800; letter-spacing: -2px; line-height: 1; }

        /* Fingerprint Button (Updated Style) */
        .scan-btn-container {
            width: 90px; height: 90px;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.02));
            border-radius: 30px; /* Squircle */
            display: flex; align-items: center; justify-content: center;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 40px rgba(0, 240, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .scan-btn-container:active { transform: scale(0.9); border-color: var(--accent-cyan); }
        .scan-btn-container.scanning { border-color: var(--accent-cyan); box-shadow: 0 0 50px var(--accent-cyan); animation: breath 1.5s infinite; }
        @keyframes breath { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        /* --- APPLE PAY STYLE ALIGNMENT HINT --- */
        #align-hint {
            position: absolute; top: 15%; left: 50%; transform: translateX(-50%);
            background: rgba(20, 20, 20, 0.85);
            backdrop-filter: blur(20px);
            padding: 12px 24px;
            border-radius: 100px;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; gap: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
            opacity: 0; pointer-events: none; z-index: 50;
        }
        #align-hint.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        /* Shimmer Effect for Hint */
        #align-hint::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transform: skewX(-20deg); animation: shimmer 2s infinite;
        }
        @keyframes shimmer { 0% { left: -100%; } 100% { left: 200%; } }

        /* Progress Bar (Liquid Style) */
        .liquid-progress {
            width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden;
            margin-top: 20px;
        }
        .liquid-fill {
            height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple));
            border-radius: 10px; transition: width 0.1s linear;
        }

        /* --- RESULT PAGE GRID --- */
        .result-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: auto auto auto;
            gap: 16px;
            height: 100%;
        }
        .span-2 { grid-column: span 2; }
        .h-full-card { height: 100%; }

    </style>
</head>
<body>
    <video id="input-video" playsinline webkit-playsinline></video>
    <div id="universe"></div>

    <!-- LAYER 1: BOOT SEQUENCE -->
    <div id="boot-layer" class="layer active bg-black z-50 flex items-center justify-center">
        <div class="text-center space-y-4">
            <div class="w-16 h-16 rounded-3xl bg-gradient-to-br from-cyan-500 to-purple-600 mx-auto animate-pulse flex items-center justify-center">
                <i data-lucide="sparkles" class="text-white w-8 h-8"></i>
            </div>
            <div class="font-mono text-xs text-cyan-400 tracking-widest">TENKI v21.0<br>GALAXY BENTO</div>
        </div>
    </div>

    <!-- LAYER 2: HOME (SCAN TRIGGER) -->
    <div id="home-layer" class="layer justify-end pb-12">
        <div class="absolute top-12 left-6">
            <h1 class="text-3xl font-bold tracking-tight text-white mb-1">Soul Sync</h1>
            <p class="text-sm text-gray-400">Ready for bio-metric alignment</p>
        </div>

        <!-- Central Visualization Area (Transparent) -->
        <div class="flex-1"></div>

        <!-- Bottom Trigger Area -->
        <div class="bento-card p-6 flex items-center justify-between">
            <div>
                <div class="txt-label mb-1 text-cyan-400">QUICK SCAN</div>
                <div class="text-sm text-gray-300">2-Second Analysis</div>
            </div>
            <div id="scan-trigger" class="scan-btn-container">
                <i data-lucide="fingerprint" class="w-10 h-10 text-white"></i>
            </div>
        </div>
    </div>

    <!-- LAYER 3: SCANNING (WITH APPLE PAY STYLE HINTS) -->
    <div id="scan-layer" class="layer justify-center items-center backdrop-blur-sm bg-black/20">
        
        <!-- Smart Alignment Hint -->
        <div id="align-hint">
            <div id="hint-icon-container" class="w-6 h-6 rounded-full bg-cyan-500/20 flex items-center justify-center">
                <i id="hint-icon" data-lucide="scan-face" class="w-4 h-4 text-cyan-400"></i>
            </div>
            <span id="hint-text" class="text-sm font-bold tracking-wide">Looking for Face...</span>
        </div>

        <div class="w-full max-w-xs text-center">
            <div class="mb-8 relative">
                <!-- Decorative Orbit Rings -->
                <div class="w-48 h-48 rounded-full border border-white/10 absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 animate-[spin_10s_linear_infinite]"></div>
                <div class="w-32 h-32 rounded-full border border-cyan-500/30 absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 animate-[spin_5s_linear_infinite_reverse]"></div>
                
                <div class="text-6xl font-bold tabular-nums" id="scan-percent">0</div>
                <div class="text-xs text-cyan-400 tracking-[4px] mt-2">ANALYZING</div>
            </div>
            
            <div class="liquid-progress">
                <div id="scan-bar" class="liquid-fill"></div>
            </div>
            <p class="text-xs text-gray-500 mt-4">Keep your finger on the sensor</p>
        </div>
    </div>

    <!-- LAYER 4: RESULT DASHBOARD (GO CLUB STYLE) -->
    <div id="result-layer" class="layer">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <div class="text-xs font-bold text-gray-500 uppercase tracking-widest">Analysis Complete</div>
                <div class="text-xl font-bold text-white">Your Emotional State</div>
            </div>
            <div class="w-10 h-10 rounded-full border border-white/10 flex items-center justify-center bg-white/5">
                <i data-lucide="user" class="w-5 h-5 text-gray-400"></i>
            </div>
        </div>

        <!-- Bento Grid -->
        <div class="result-grid flex-1">
            
            <!-- 1. ERI Score (Main Card) - Gradient Background -->
            <div class="bento-card span-2 p-6 relative overflow-hidden group">
                <div class="absolute inset-0 bg-gradient-to-r from-blue-600/20 to-purple-600/20 opacity-50"></div>
                <div class="card-content flex flex-row justify-between items-center">
                    <div>
                        <div class="txt-label mb-2 text-cyan-300">ERI SCORE</div>
                        <div class="txt-huge" id="res-eri">72</div>
                        <div class="inline-flex items-center gap-2 mt-2 px-3 py-1 rounded-full bg-white/10 border border-white/10">
                            <div class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                            <span class="text-xs font-bold" id="res-status">HIGH ENERGY</span>
                        </div>
                    </div>
                    <!-- Decorative Chart SVG -->
                    <div class="w-24 h-24 opacity-80">
                         <svg viewBox="0 0 100 100" class="w-full h-full stroke-cyan-400 fill-none stroke-2">
                             <path d="M10,90 Q30,80 50,50 T90,20" />
                             <circle cx="90" cy="20" r="4" class="fill-cyan-400" />
                         </svg>
                    </div>
                </div>
            </div>

            <!-- 2. HRV (Square) -->
            <div class="bento-card p-5">
                <div class="card-content justify-between">
                    <div class="flex justify-between">
                        <div class="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center">
                            <i data-lucide="heart-pulse" class="w-4 h-4 text-green-400"></i>
                        </div>
                        <span class="text-xs text-green-400 font-bold">+5%</span>
                    </div>
                    <div>
                        <div class="txt-value" id="res-hrv">42</div>
                        <div class="txt-label mt-1">HRV (ms)</div>
                    </div>
                </div>
            </div>

            <!-- 3. Resp (Square) -->
            <div class="bento-card p-5">
                <div class="card-content justify-between">
                    <div class="flex justify-between">
                        <div class="w-8 h-8 rounded-full bg-orange-500/20 flex items-center justify-center">
                            <i data-lucide="wind" class="w-4 h-4 text-orange-400"></i>
                        </div>
                        <span class="text-xs text-gray-500">Normal</span>
                    </div>
                    <div>
                        <div class="txt-value" id="res-resp">16</div>
                        <div class="txt-label mt-1">Breaths/min</div>
                    </div>
                </div>
            </div>

            <!-- 4. Strategy Card (Wide) -->
            <div class="bento-card span-2 p-5">
                <div class="card-content">
                    <div class="flex items-center gap-2 mb-3">
                        <i data-lucide="crosshair" class="w-4 h-4 text-purple-400"></i>
                        <div class="txt-label text-purple-300">Strategy Unlocked</div>
                    </div>
                    <div class="text-lg font-bold leading-tight" id="res-strategy">
                        Failed Breakdown <span class="text-gray-500">&</span> Scalping
                    </div>
                    <div class="mt-3 h-1 w-full bg-white/10 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-purple-500 to-cyan-500 w-[70%]"></div>
                    </div>
                </div>
            </div>
            
            <!-- 5. Actions Row -->
            <div class="span-2 grid grid-cols-2 gap-4 mt-auto">
                <button onclick="App.reset()" class="bento-card p-4 flex items-center justify-center gap-2 active:scale-95 transition-transform bg-white/5 hover:bg-white/10">
                    <i data-lucide="rotate-ccw" class="w-4 h-4 text-gray-400"></i>
                    <span class="text-sm font-bold">Resync</span>
                </button>
                <button onclick="alert('Journal Saved')" class="bento-card p-4 flex items-center justify-center gap-2 active:scale-95 transition-transform bg-cyan-500/10 border-cyan-500/30">
                    <i data-lucide="check" class="w-4 h-4 text-cyan-400"></i>
                    <span class="text-sm font-bold text-cyan-400">Confirm</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        const App = {
            state: {
                isScanning: false,
                faceDetected: false,
                landmarks: null,
                scanProgress: 0,
                hintState: 'search' // search, good, move-closer, move-left, move-right
            },
            
            three: { scene:null, camera:null, renderer:null, cloud:null, material:null },

            init: function() {
                this.initThree();
                this.initAI();
                this.setupEvents();
                
                // Boot Sequence
                setTimeout(() => {
                    document.getElementById('boot-layer').style.opacity = 0;
                    setTimeout(() => {
                        document.getElementById('boot-layer').style.display = 'none';
                        document.getElementById('home-layer').classList.add('active');
                    }, 600);
                }, 2000);
            },

            // --- SMART ALIGNMENT LOGIC (The "Apple Pay" Brain) ---
            updateAlignmentHint: function(landmarks) {
                const hintEl = document.getElementById('align-hint');
                const iconEl = document.getElementById('hint-icon-container');
                const textEl = document.getElementById('hint-text');
                let newState = 'good';
                let msg = "Hold Still";
                let icon = "check-circle";
                let colorClass = "text-green-400";
                let bgClass = "bg-green-500/20";

                if (!landmarks) {
                    newState = 'search';
                    msg = "Find Face";
                    icon = "scan-face";
                    colorClass = "text-red-400";
                    bgClass = "bg-red-500/20";
                } else {
                    const nose = landmarks[1]; // Index 1 is nose tip
                    const leftCheek = landmarks[234];
                    const rightCheek = landmarks[454];
                    
                    // 1. Center Check X (Mirror effect handled in logic)
                    if (nose.x < 0.35) {
                        newState = 'move-left'; // Move actual head right (camera mirrored)
                        msg = "Move Right →";
                        icon = "arrow-right";
                        colorClass = "text-yellow-400";
                        bgClass = "bg-yellow-500/20";
                    } else if (nose.x > 0.65) {
                        newState = 'move-right';
                        msg = "← Move Left";
                        icon = "arrow-left";
                        colorClass = "text-yellow-400";
                        bgClass = "bg-yellow-500/20";
                    } else {
                        // 2. Distance Check (Width of face)
                        const faceWidth = Math.abs(leftCheek.x - rightCheek.x);
                        if (faceWidth < 0.35) { // Too far
                            newState = 'closer';
                            msg = "Move Closer";
                            icon = "maximize";
                            colorClass = "text-cyan-400";
                            bgClass = "bg-cyan-500/20";
                        }
                    }
                }

                // UI Update (Only if state changes or periodically)
                if (this.state.hintState !== newState) {
                    this.state.hintState = newState;
                    textEl.innerText = msg;
                    // Reset classes
                    iconEl.className = `w-6 h-6 rounded-full flex items-center justify-center transition-colors ${bgClass}`;
                    // Update Lucide icon manually by re-rendering HTML
                    iconEl.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4 ${colorClass}"></i>`;
                    lucide.createIcons();
                    
                    // Haptic feedback on 'good'
                    if (newState === 'good' && navigator.vibrate) navigator.vibrate(20);
                }
                
                // Show hint if scanning
                if (this.state.isScanning) {
                    hintEl.classList.add('show');
                } else {
                    hintEl.classList.remove('show');
                }
            },

            // --- THREE.JS STARDUST ENGINE ---
            initThree: function() {
                const container = document.getElementById('universe');
                this.three.scene = new THREE.Scene();
                this.three.camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
                this.three.camera.position.z = 5;
                this.three.renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
                this.three.renderer.setSize(window.innerWidth, window.innerHeight);
                this.three.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                container.appendChild(this.three.renderer.domElement);

                // Galaxy Particles
                const geometry = new THREE.BufferGeometry();
                const count = 6000;
                const pos = [], sizes = [];
                for(let i=0; i<count; i++) {
                    const r = 4 * Math.sqrt(Math.random());
                    const theta = Math.random() * 2 * Math.PI;
                    const x = r * Math.cos(theta);
                    const y = r * Math.sin(theta) * 0.8; // Elliptical
                    const z = (Math.random() - 0.5) * 2;
                    pos.push(x, y, z);
                    sizes.push(Math.random());
                }
                geometry.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
                geometry.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));

                this.three.material = new THREE.PointsMaterial({
                    size: 0.05,
                    color: 0x00F0FF,
                    transparent: true,
                    opacity: 0.8,
                    blending: THREE.AdditiveBlending
                });

                this.three.cloud = new THREE.Points(geometry, this.three.material);
                this.three.scene.add(this.three.cloud);
                this.animate();
            },

            animate: function() {
                requestAnimationFrame(() => this.animate());
                const time = Date.now() * 0.0005;
                
                // Rotate galaxy
                this.three.cloud.rotation.z = time * 0.1;
                this.three.cloud.rotation.x = Math.sin(time * 0.5) * 0.1;

                // Color Shift based on scanning
                if(this.state.isScanning) {
                    this.three.material.color.setHex(0x9D00FF); // Purple when scanning
                } else {
                    this.three.material.color.setHex(0x00F0FF); // Cyan normally
                }
                
                this.three.renderer.render(this.three.scene, this.three.camera);
            },

            // --- AI & LOGIC ---
            initAI: function() {
                const video = document.getElementById('input-video');
                const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
                faceMesh.setOptions({maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5});
                
                faceMesh.onResults((res) => {
                    if (res.multiFaceLandmarks && res.multiFaceLandmarks.length > 0) {
                        this.state.faceDetected = true;
                        this.state.landmarks = res.multiFaceLandmarks[0];
                    } else {
                        this.state.faceDetected = false;
                        this.state.landmarks = null;
                    }
                    
                    // Real-time alignment calculation
                    if (this.state.isScanning) {
                        this.updateAlignmentHint(this.state.landmarks);
                    }
                });
                
                const camera = new Camera(video, {
                    onFrame: async () => await faceMesh.send({image: video}),
                    width: 640, height: 480
                });
                camera.start();
            },

            // --- INTERACTIONS ---
            setupEvents: function() {
                const btn = document.getElementById('scan-trigger');
                
                const start = (e) => {
                    e.preventDefault();
                    if(this.state.isScanning) return;
                    
                    // Transition to Scan Layer
                    this.state.isScanning = true;
                    document.getElementById('home-layer').classList.remove('active');
                    document.getElementById('scan-layer').classList.add('active');
                    btn.classList.add('scanning');
                    
                    if(navigator.vibrate) navigator.vibrate(50);
                    
                    // Start Progress
                    this.runScanProgress();
                };
                
                btn.addEventListener('mousedown', start);
                btn.addEventListener('touchstart', start, {passive: false});
            },

            runScanProgress: function() {
                let p = 0;
                const percentEl = document.getElementById('scan-percent');
                const barEl = document.getElementById('scan-bar');
                
                const interval = setInterval(() => {
                    // Slow down if face alignment is bad
                    const speed = (this.state.hintState === 'good') ? 1.5 : 0.2;
                    p += speed;
                    
                    // Visual Update
                    const dispP = Math.floor(p);
                    percentEl.innerText = dispP;
                    barEl.style.width = dispP + "%";
                    
                    if (p >= 100) {
                        clearInterval(interval);
                        this.finishScan();
                    }
                }, 30);
            },

            finishScan: function() {
                this.state.isScanning = false;
                if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
                
                // Hide Scan, Show Result
                document.getElementById('scan-layer').classList.remove('active');
                document.getElementById('result-layer').classList.add('active');
                
                // Simulate Data Population
                const score = Math.floor(Math.random() * (92 - 65) + 65);
                document.getElementById('res-eri').innerText = score;
                
                const status = score > 75 ? "HIGH ENERGY" : "BALANCED";
                document.getElementById('res-status').innerText = status;
                
                document.getElementById('res-hrv').innerText = Math.floor(Math.random() * 60 + 30);
                document.getElementById('res-resp').innerText = Math.floor(Math.random() * 6 + 12);
            },

            reset: function() {
                document.getElementById('result-layer').classList.remove('active');
                document.getElementById('home-layer').classList.add('active');
                document.getElementById('scan-trigger').classList.remove('scanning');
                document.getElementById('scan-bar').style.width = '0%';
                document.getElementById('scan-percent').innerText = '0';
            }
        };

        window.onload = () => App.init();
        window.onresize = () => {
            App.three.camera.aspect = window.innerWidth/window.innerHeight;
            App.three.camera.updateProjectionMatrix();
            App.three.renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>
