<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TENKI PRO v4.0 - Decision OS</title>
    
    <!-- 字體庫 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <!-- 核心引擎 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    
    <!-- UI 庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --bg-deep: #050510;
            --plasma-cyan: #23F3D4;
            --sunset-orange: #FF5E3A; /* 警告色 */
            --stardust-purple: #9575FF;
            --glass-bg: rgba(15, 15, 25, 0.85);
            --glass-border: rgba(255, 255, 255, 0.08);
            --mancini-red: #FF3B30;
            --mancini-green: #23F3D4;
        }

        body {
            background: var(--bg-deep);
            color: white;
            font-family: 'Space Mono', monospace;
            overflow: hidden;
            width: 100vw; height: 100vh;
            margin: 0; padding: 0;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .font-serif-human { font-family: 'Playfair Display', serif; }
        .font-mono-tech { font-family: 'Space Mono', monospace; }

        /* 1. 視覺層 (粒子與背景) - 保持不變 */
        #input-video { position: fixed; top: -9999px; left: -9999px; opacity: 0; pointer-events: none; }
        #universe {
            position: absolute; inset: 0; z-index: 1;
            background: radial-gradient(circle at center, #1a1a2e 0%, #000000 100%);
            transition: opacity 1s ease;
        }
        #universe.dimmed { opacity: 0.2; filter: blur(15px); } /* v4.0: 更深的模糊以突出儀表板 */

        /* 2. HUD 掃描層 - 保持不變 */
        #hud-layer {
            position: absolute; inset: 0; z-index: 10;
            pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 24px;
            transition: opacity 0.5s ease;
        }
        #hud-layer.hidden-ui { opacity: 0; pointer-events: none; transform: scale(1.1); }

        /* Alignment UI */
        #align-hint-capsule {
            position: absolute; top: 15%; left: 50%; 
            transform: translateX(-50%) translateY(-20px) scale(0.95);
            background: rgba(20, 20, 25, 0.75);
            backdrop-filter: blur(20px);
            padding: 10px 20px; border-radius: 99px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; align-items: center; gap: 12px;
            opacity: 0; pointer-events: none; 
            transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            z-index: 100;
        }
        #align-hint-capsule.show { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); pointer-events: auto; }
        
        .fingerprint-sensor {
            pointer-events: auto; position: relative;
            width: 80px; height: 80px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: all 0.3s;
            backdrop-filter: blur(8px);
        }
        .fingerprint-sensor.active {
            transform: scale(1.1); border-color: var(--stardust-purple);
            background: rgba(149, 117, 255, 0.2); box-shadow: 0 0 40px var(--stardust-purple);
        }

        /* 3. PRO DASHBOARD LAYER (v4.0 核心) */
        #dashboard-layer {
            position: absolute; inset: 0; z-index: 50;
            background: transparent;
            display: flex; flex-direction: column;
            padding: 24px 20px 20px 20px;
            overflow-y: auto; opacity: 0; pointer-events: none;
            transform: translateY(30px);
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #dashboard-layer.show { opacity: 1; pointer-events: auto; transform: translateY(0); }

        /* v4.0 TEI Triple Ring */
        .tei-container {
            position: relative; width: 220px; height: 220px; margin: 0 auto 20px auto;
            display: flex; justify-content: center; align-items: center;
        }
        .ring { position: absolute; border-radius: 50%; transition: all 1s ease; }
        
        /* Inner: Mercury (Face) */
        .ring-inner { width: 140px; height: 140px; border: 2px solid rgba(255,255,255,0.1); box-shadow: 0 0 20px rgba(255,255,255,0.05); z-index: 3; }
        
        /* Middle: Plasma (HRV) */
        .ring-mid { width: 180px; height: 180px; border: 1px dashed rgba(35, 243, 212, 0.3); z-index: 2; animation: rotate-slow 20s linear infinite; }
        
        /* Outer: Stardust (Load) */
        .ring-outer { width: 220px; height: 220px; border: 1px solid rgba(149, 117, 255, 0.1); z-index: 1; }
        
        /* Dynamic Fill */
        .tei-fill {
            position: absolute; inset: 0; border-radius: 50%;
            background: conic-gradient(var(--plasma-cyan) 0% 0%, transparent 0% 100%);
            transition: background 1s cubic-bezier(0.2, 0.8, 0.2, 1);
            filter: drop-shadow(0 0 10px var(--plasma-cyan));
        }

        /* Friction Mode Styling */
        .friction-active .tei-fill { background: conic-gradient(var(--sunset-orange) 0% 0%, transparent 0% 100%); filter: drop-shadow(0 0 15px var(--sunset-orange)); }
        .friction-active .tei-score { color: var(--sunset-orange); text-shadow: 0 0 20px rgba(255, 94, 58, 0.5); }
        .friction-border {
            position: absolute; inset: 0; pointer-events: none; z-index: 999;
            border: 2px solid var(--sunset-orange); opacity: 0;
            animation: pulse-border 2s infinite;
        }
        @keyframes pulse-border { 0% { opacity: 0; } 50% { opacity: 0.6; } 100% { opacity: 0; } }

        /* Mancini Timer Card */
        .mancini-card {
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            border-radius: 20px; padding: 20px; margin-bottom: 12px;
            position: relative; overflow: hidden;
            border-left: 2px solid var(--glass-border); /* Edge line */
            transition: all 0.3s;
        }
        .mancini-card.phase-wait { border-left-color: var(--mancini-red); }
        .mancini-card.phase-go { border-left-color: var(--mancini-green); box-shadow: 0 0 20px rgba(35, 243, 212, 0.1); }

        /* Modal for Friction */
        #friction-modal {
            position: absolute; inset: 0; z-index: 200;
            background: rgba(5, 5, 10, 0.95); backdrop-filter: blur(10px);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            padding: 40px; text-align: center;
        }
        #friction-modal.active { opacity: 1; pointer-events: auto; }

        .btn-friction {
            margin-top: 24px; padding: 16px 32px;
            background: rgba(255, 94, 58, 0.1); border: 1px solid var(--sunset-orange);
            color: var(--sunset-orange); font-family: 'Space Mono', monospace;
            font-size: 12px; letter-spacing: 1px; cursor: pointer;
            transition: all 0.2s;
        }
        .btn-friction:active { background: var(--sunset-orange); color: black; }
        .btn-friction:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        @keyframes rotate-slow { 100% { transform: rotate(360deg); } }
        
        /* Audio Bars */
        .audio-bar { width: 4px; height: 20px; background: rgba(255,255,255,0.2); margin: 0 1px; border-radius: 2px; }

    </style>
</head>
<body>

    <video id="input-video" playsinline></video>
    <div id="universe"></div>

    <!-- HUD Layer (Scanning) -->
    <div id="hud-layer">
        <div id="align-hint-capsule">
            <div id="hint-icon-box" class="w-6 h-6 rounded-full flex items-center justify-center">
                <i id="hint-icon" data-lucide="scan-face" class="w-4 h-4 text-white"></i>
            </div>
            <span id="hint-text" class="text-xs font-bold text-white tracking-wide uppercase">Searching...</span>
        </div>

        <div class="flex justify-between items-start">
            <div>
                <div class="text-xl font-bold tracking-[6px] text-white font-mono-tech">TENKI PRO</div>
                <div class="text-[8px] text-cyan-400 tracking-widest mt-1 font-mono-tech border border-cyan-900 bg-cyan-900/20 px-2 py-0.5 inline-block rounded">
                    DECISION_OS_v4.0
                </div>
            </div>
            <div class="text-right flex flex-col items-end">
                <div id="connection-status" class="text-[10px] text-gray-400 border border-white/10 px-2 py-1 rounded mb-2 font-mono-tech transition-all">
                    IDLE
                </div>
                <div class="flex items-end h-4" id="audio-visualizer">
                    <div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div>
                </div>
            </div>
        </div>

        <div class="flex flex-col items-center pb-10">
            <div id="scan-trigger" class="fingerprint-sensor">
                <i data-lucide="fingerprint" class="w-8 h-8 text-white/80"></i>
            </div>
            <div id="instruction" class="mt-6 text-[10px] tracking-[3px] text-gray-400 font-mono-tech">
                TAP TO INITIALIZE
            </div>
        </div>
    </div>

    <!-- PRO Dashboard Layer (v4.0) -->
    <div id="dashboard-layer">
        
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <div class="text-[10px] text-gray-400 font-mono-tech tracking-wider">TEI ENGINE</div>
                <div class="text-2xl text-white font-serif-human italic">State Mirror</div>
            </div>
            <div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center border border-white/10">
                <i data-lucide="layers" class="w-4 h-4 text-white"></i>
            </div>
        </div>

        <!-- TEI Triple Ring Core -->
        <div class="tei-container">
            <div class="ring ring-outer"></div>
            <div class="ring ring-mid"></div>
            <div class="ring ring-inner bg-[#050510] flex flex-col items-center justify-center overflow-hidden">
                <div id="tei-fill-layer" class="tei-fill"></div>
                <div class="z-10 text-center">
                    <div class="text-5xl font-bold text-white font-mono-tech tei-score" id="pro-score">--</div>
                    <div class="text-[9px] text-gray-400 tracking-[3px] mt-1 font-bold" id="pro-label">CALCULATING</div>
                </div>
            </div>
        </div>

        <!-- Friction Warning Banner (Hidden by default) -->
        <div id="friction-banner" class="hidden mb-4 p-3 border border-red-500/50 bg-red-900/20 rounded-lg flex items-center gap-3">
            <i data-lucide="triangle-alert" class="w-5 h-5 text-red-500"></i>
            <div>
                <div class="text-[10px] text-red-400 font-bold">PHYSIOLOGICAL DRIFT</div>
                <div class="text-[9px] text-red-300/70">Historical Win Rate at this state: 18%</div>
            </div>
        </div>

        <!-- Mancini FBD Timer -->
        <div class="mancini-card" id="mancini-card">
            <div class="flex justify-between items-start mb-2">
                <div class="text-[10px] text-gray-400 font-mono-tech">MANCINI FBD TIMER</div>
                <div class="text-[10px] text-gray-500">3MIN</div>
            </div>
            <div class="flex items-baseline gap-2">
                <div class="text-3xl font-bold text-white font-mono-tech" id="timer-display">00:00</div>
                <div class="text-[10px] text-gray-500" id="k-line-countdown">K-Line: --</div>
            </div>
            <div class="w-full bg-gray-800 h-1 mt-3 rounded-full overflow-hidden">
                <div id="timer-bar" class="h-full bg-gray-500 w-0 transition-all duration-1000"></div>
            </div>
            <div class="flex justify-between mt-2">
                <div class="text-[9px] text-gray-600">Phase: <span id="timer-phase">IDLE</span></div>
                <i data-lucide="play-circle" class="w-5 h-5 text-white cursor-pointer hover:text-cyan-400" id="btn-start-timer"></i>
            </div>
        </div>

        <!-- Action Hot Zone -->
        <div class="grid grid-cols-2 gap-3 mb-8">
            <div class="bg-white/5 border border-white/10 rounded-xl p-3 flex flex-col items-center justify-center hover:bg-white/10 cursor-pointer active:scale-95 transition">
                <i data-lucide="refresh-ccw" class="w-4 h-4 text-cyan-400 mb-1"></i>
                <div class="text-[9px] font-bold">15s CALIBRATE</div>
            </div>
            <div class="bg-white/5 border border-white/10 rounded-xl p-3 flex flex-col items-center justify-center hover:bg-white/10 cursor-pointer active:scale-95 transition">
                <i data-lucide="clipboard-list" class="w-4 h-4 text-purple-400 mb-1"></i>
                <div class="text-[9px] font-bold">LOG STATE</div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-[8px] text-gray-600 text-center px-4 leading-relaxed">
            LEGAL: TENKI IS A SELF-DISCIPLINE TOOL, NOT AN INVESTMENT ADVISOR. DECISION SOVEREIGNTY BELONGS TO YOU.
        </div>
    </div>

    <!-- Friction Warning Modal -->
    <div id="friction-modal">
        <div class="w-16 h-16 rounded-full bg-red-500/20 flex items-center justify-center mb-4 animate-pulse">
            <i data-lucide="octagon-alert" class="w-8 h-8 text-red-500"></i>
        </div>
        <div class="text-xl font-bold text-white font-serif-human mb-2">System Friction</div>
        <div class="text-[11px] text-gray-400 mb-6 max-w-[260px] leading-relaxed">
            Your TEI score (58) indicates low resilience. <br>
            <span class="text-red-400">Force Cool-down Activated.</span>
        </div>
        <button id="btn-friction-confirm" class="btn-friction" disabled>
            I ACKNOWLEDGE RISK (5s)
        </button>
    </div>

    <!-- Friction Border Effect -->
    <div id="friction-border" class="friction-border hidden"></div>

    <script>
        lucide.createIcons();

        // --- CORE APP LOGIC ---
        const app = {
            config: { particleCount: 6000, particleSize: 0.08 },
            state: { 
                sensorsActive: false, isScanning: false, 
                mouthOpen: 0, headRot: {x:0, y:0}, audioData: 0, energy: 0,
                // v4.0 PRO STATES
                teiScore: 0,
                frictionMode: false
            },
            audioCtx: null, analyser: null, stream: null, faceMesh: null, camera: null,

            init: function() {
                this.initThree();
                this.initEvents();
                
                // Date
                const d = new Date();
                // document.getElementById('dash-date').innerText = d.toLocaleDateString('en-US').toUpperCase();
            },

            // --- 1. SENSORS & PRIVACY SEAL (v24.0 Base) ---
            startSensors: async function() {
                const hint = document.getElementById('instruction');
                hint.innerText = "SENSORS WAKING...";
                try {
                    this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = this.audioCtx.createAnalyser();
                    this.stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
                    const src = this.audioCtx.createMediaStreamSource(this.stream);
                    src.connect(this.analyser);
                    
                    const video = document.getElementById('input-video');
                    video.srcObject = this.stream;
                    video.play();

                    if(!this.faceMesh) {
                        this.faceMesh = new FaceMesh({locateFile: f=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`});
                        this.faceMesh.setOptions({maxNumFaces:1, refineLandmarks:true});
                        this.faceMesh.onResults(res => this.processFace(res));
                    }
                    this.camera = new Camera(video, {
                        onFrame: async()=>{ if(this.state.sensorsActive) await this.faceMesh.send({image:video}); },
                        width:640, height:480
                    });
                    this.camera.start();
                    this.state.sensorsActive = true;
                } catch(e) {
                    console.error(e);
                    hint.innerText = "ACCESS DENIED";
                }
            },

            stopSensors: function() {
                if(this.stream) this.stream.getTracks().forEach(t=>t.stop());
                if(this.audioCtx) this.audioCtx.close();
                this.state.sensorsActive = false;
                
                const status = document.getElementById('connection-status');
                status.innerHTML = `<i data-lucide="shield-check" class="w-3 h-3 text-green-400"></i> PRIVACY SECURED`;
                status.className = "text-[9px] text-green-400 bg-green-900/20 border border-green-500/30 px-2 py-1 rounded mb-2 font-mono-tech flex items-center gap-1";
                lucide.createIcons();
            },

            processFace: function(res) {
                if(!this.state.sensorsActive || !res.multiFaceLandmarks[0]) return;
                const lm = res.multiFaceLandmarks[0];
                this.updateAlignment(lm);
                
                this.state.headRot.x = (lm[1].y - 0.5)*2;
                this.state.headRot.y = (lm[1].x - 0.5)*2;
                const d = Math.sqrt(Math.pow(lm[13].x-lm[14].x,2)+Math.pow(lm[13].y-lm[14].y,2));
                this.state.mouthOpen += ((d*5)-this.state.mouthOpen)*0.1;
                
                const status = document.getElementById('connection-status');
                if(!status.innerText.includes("SECURED")) {
                    status.innerHTML = "VISION ACTIVE";
                    status.className = "text-[10px] text-purple-400 border border-purple-500/30 px-2 py-1 rounded mb-2 font-mono-tech";
                }
            },

            updateAlignment: function(lm) {
                if(this.state.isScanning) return;
                const cap = document.getElementById('align-hint-capsule');
                const txt = document.getElementById('hint-text');
                // Simple logic
                const ready = lm && Math.abs(lm[234].x - lm[454].x) > 0.3;
                if(ready && txt.innerText !== "READY") {
                    txt.innerText = "READY";
                    cap.classList.add('show');
                    document.getElementById('hint-icon').style.color = "#23F3D4";
                }
            },

            // --- 2. ANIMATION (Phantom Mode) ---
            initThree: function() {
                const container = document.getElementById('universe');
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
                this.camera.position.z = 5;
                this.renderer = new THREE.WebGLRenderer({alpha:true});
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                container.appendChild(this.renderer.domElement);
                
                // Particles
                const geo = new THREE.BufferGeometry();
                const pos = new Float32Array(this.config.particleCount*3);
                for(let i=0; i<this.config.particleCount*3; i++) pos[i]=(Math.random()-0.5)*10;
                geo.setAttribute('position', new THREE.BufferAttribute(pos,3));
                
                const mat = new THREE.PointsMaterial({size:0.06, color:0x23F3D4, transparent:true, opacity:0.6});
                this.cloud = new THREE.Points(geo, mat);
                this.scene.add(this.cloud);

                const animate = () => {
                    requestAnimationFrame(animate);
                    const time = Date.now()*0.001;
                    
                    if(this.state.sensorsActive && this.analyser) {
                        const data = new Uint8Array(this.analyser.frequencyBinCount);
                        this.analyser.getByteFrequencyData(data);
                        let sum=0; for(let i=0; i<data.length; i++) sum+=data[i];
                        this.state.audioData = sum/data.length;
                        
                        // Audio Bars
                        document.querySelectorAll('.audio-bar').forEach((b,i)=> {
                            b.style.height = Math.max(3, (data[i*4]/255)*16)+'px';
                        });
                        
                        this.cloud.rotation.y += 0.003;
                        this.cloud.scale.setScalar(1 + (this.state.audioData/255)*0.5);
                    } else {
                        // Phantom Breathing
                        this.cloud.rotation.y += 0.001;
                        this.cloud.scale.setScalar(1 + Math.sin(time)*0.05);
                        this.state.headRot.x *= 0.95;
                    }
                    this.renderer.render(this.scene, this.camera);
                };
                animate();
            },

            // --- 3. INTERACTION & v4.0 LOGIC ---
            initEvents: function() {
                const btn = document.getElementById('scan-trigger');
                
                const start = (e) => {
                    e.preventDefault();
                    if(!this.state.sensorsActive) { this.startSensors(); return; }
                    
                    this.state.isScanning = true;
                    btn.classList.add('active');
                    document.getElementById('instruction').innerText = "CALIBRATING...";
                    document.getElementById('align-hint-capsule').classList.remove('show');
                    
                    let p=0;
                    this.timer = setInterval(()=>{
                        p+=2; if(p>=100) this.completeScan();
                    }, 40); // 2s scan
                };
                
                const end = () => {
                    this.state.isScanning = false;
                    clearInterval(this.timer);
                    btn.classList.remove('active');
                };
                
                btn.addEventListener('mousedown', start); btn.addEventListener('touchstart', start);
                window.addEventListener('mouseup', end); window.addEventListener('touchend', end);
                
                // Timer Button
                document.getElementById('btn-start-timer').addEventListener('click', () => this.startManciniTimer());
            },

            completeScan: function() {
                clearInterval(this.timer);
                this.state.isScanning = false;
                
                // 1. Privacy Seal (Immediate)
                this.stopSensors();
                
                // 2. Simulate Result (DEMO: Set Low Score for Friction)
                // In production, this comes from Cloud Run API
                this.state.teiScore = 58; // < 62 triggers friction
                this.state.frictionMode = this.state.teiScore <= 62;
                
                this.showProDashboard();
            },

            showProDashboard: function() {
                document.getElementById('hud-layer').classList.add('hidden-ui');
                document.getElementById('universe').classList.add('dimmed');
                document.getElementById('dashboard-layer').classList.add('show');
                
                // Update TEI UI
                const score = this.state.teiScore;
                document.getElementById('pro-score').innerText = score;
                document.getElementById('pro-label').innerText = this.state.frictionMode ? "LOW RESILIENCE" : "OPTIMAL";
                
                const fill = document.getElementById('tei-fill-layer');
                const pct = score;
                fill.style.background = `conic-gradient(var(--plasma-cyan) 0% ${pct}%, transparent ${pct}% 100%)`;

                // --- FRICTION SYSTEM LOGIC ---
                if (this.state.frictionMode) {
                    // Activate Warning Styling
                    document.getElementById('dashboard-layer').classList.add('friction-active');
                    document.getElementById('friction-banner').classList.remove('hidden');
                    document.getElementById('friction-border').classList.remove('hidden');
                    
                    // Trigger Modal
                    setTimeout(() => {
                        this.triggerFrictionModal();
                    }, 800);
                }
            },

            triggerFrictionModal: function() {
                const modal = document.getElementById('friction-modal');
                const btn = document.getElementById('btn-friction-confirm');
                modal.classList.add('active');
                if(navigator.vibrate) navigator.vibrate([100, 50, 100]);

                let countdown = 5;
                btn.innerText = `FORCED COOL-DOWN (${countdown}s)`;
                
                const countTimer = setInterval(() => {
                    countdown--;
                    if(countdown > 0) {
                        btn.innerText = `FORCED COOL-DOWN (${countdown}s)`;
                    } else {
                        clearInterval(countTimer);
                        btn.innerText = "I ACKNOWLEDGE RISK & CONTINUE";
                        btn.disabled = false;
                        btn.style.borderColor = "#fff";
                        btn.style.color = "#fff";
                        if(navigator.vibrate) navigator.vibrate(50);
                    }
                }, 1000);

                btn.onclick = () => {
                    modal.classList.remove('active');
                    // Log behavior here (omitted for MVP)
                };
            },

            startManciniTimer: function() {
                if(this.timerRunning) return;
                this.timerRunning = true;
                
                const display = document.getElementById('timer-display');
                const bar = document.getElementById('timer-bar');
                const phase = document.getElementById('timer-phase');
                const card = document.getElementById('mancini-card');
                
                let s = 0;
                const total = 180; // 3 min
                
                this.manciniInterval = setInterval(() => {
                    s++;
                    const min = Math.floor(s/60).toString().padStart(2,'0');
                    const sec = (s%60).toString().padStart(2,'0');
                    display.innerText = `${min}:${sec}`;
                    
                    // Logic: 0-60s Red (Wait), 120s+ Green (Go)
                    if (s < 60) {
                        phase.innerText = "WAIT FOR RECLAIM";
                        phase.style.color = "var(--mancini-red)";
                        card.className = "mancini-card phase-wait";
                    } else if (s > 120) {
                        phase.innerText = "ACCEPTANCE CHECK";
                        phase.style.color = "var(--mancini-green)";
                        card.className = "mancini-card phase-go";
                    } else {
                        phase.innerText = "OBSERVING...";
                        phase.style.color = "gray";
                        card.className = "mancini-card";
                    }
                    
                    bar.style.width = (s / total * 100) + "%";
                    
                    // Mock K-line countdown
                    const kRem = 45 - (s % 45); 
                    document.getElementById('k-line-countdown').innerText = `K-Line: -${kRem}s`;

                    if(s >= total) clearInterval(this.manciniInterval);
                }, 1000);
            },
            
            reset: function() {
                // Reset logic omitted for brevity in "Complete Code" request
                location.reload();
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
