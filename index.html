<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TENKI v22.0 - Seamless Galaxy</title>
    
    <!-- Core Engine -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    
    <!-- UI / Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- GLOBAL RESET & FIXES --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            --bg-deep: #050505;
            --accent-cyan: #00F0FF;
            --accent-purple: #9D00FF;
            --card-glass: rgba(30, 30, 35, 0.7);
            --card-border: rgba(255, 255, 255, 0.08);
        }

        body {
            background: var(--bg-deep);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", sans-serif;
            width: 100%; height: 100dvh; /* dvh for iOS */
            position: fixed; margin: 0; padding: 0;
            overflow: hidden; touch-action: none;
            user-select: none; -webkit-user-select: none; /* No text select */
        }

        #input-video { position: fixed; top: -9999px; left: -9999px; opacity: 0; pointer-events: none; }
        #universe { position: absolute; inset: 0; z-index: 0; pointer-events: none; }

        /* --- LAYERS SYSTEM --- */
        .layer {
            position: absolute; inset: 0; z-index: 10;
            display: flex; flex-direction: column;
            padding: calc(env(safe-area-inset-top) + 20px) 24px calc(env(safe-area-inset-bottom) + 30px) 24px;
            opacity: 0; pointer-events: none;
            transition: opacity 0.8s cubic-bezier(0.2, 0.8, 0.2, 1), transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .layer.active { opacity: 1; pointer-events: auto; transform: scale(1); }
        .layer.hidden-layer { opacity: 0; transform: scale(0.95); pointer-events: none; }

        /* --- V18.0 FINGERPRINT BUTTON (FIXED) --- */
        .fingerprint-container {
            position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 50;
            transition: opacity 0.5s ease;
        }
        
        .fingerprint-sensor {
            width: 80px; height: 80px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(4px);
            cursor: pointer; position: relative;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            /* IOS LONG PRESS FIXES */
            touch-action: none; -webkit-touch-callout: none;
        }

        .fingerprint-sensor:active, .fingerprint-sensor.active {
            transform: scale(1.1); border-color: var(--accent-cyan);
            background: rgba(0, 240, 255, 0.15); box-shadow: 0 0 40px var(--accent-cyan);
        }

        /* --- GO CLUB / GALAXY BENTO DASHBOARD --- */
        /* This layer appears AFTER scan */
        .bento-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto 1fr;
            gap: 16px;
            height: 100%;
            width: 100%;
        }

        .bento-card {
            background: var(--card-glass);
            backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
            border: 1px solid var(--card-border);
            border-radius: 32px; /* Go Club Rounded Look */
            padding: 20px;
            position: relative; overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        /* Gradient Overlays for "Galaxy" feel */
        .card-glow-cyan::before {
            content: ''; position: absolute; top: -50%; right: -50%; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(0,240,255,0.2) 0%, transparent 70%);
            filter: blur(20px); pointer-events: none;
        }
        .card-glow-purple::before {
            content: ''; position: absolute; bottom: -50%; left: -50%; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(157,0,255,0.2) 0%, transparent 70%);
            filter: blur(20px); pointer-events: none;
        }

        .col-span-2 { grid-column: span 2; }
        
        .txt-label { font-size: 12px; font-weight: 600; color: rgba(255,255,255,0.4); letter-spacing: 1px; text-transform: uppercase; }
        .txt-val { font-size: 32px; font-weight: 800; color: white; letter-spacing: -0.5px; }
        .txt-unit { font-size: 14px; font-weight: 500; color: rgba(255,255,255,0.6); margin-left: 2px; }

        /* CIRCULAR PROGRESS (Go Club Style) */
        .progress-circle {
            width: 120px; height: 120px; border-radius: 50%;
            background: conic-gradient(var(--accent-cyan) var(--pct), rgba(255,255,255,0.1) 0deg);
            display: flex; align-items: center; justify-content: center;
            position: relative; margin-left: auto;
        }
        .progress-circle::after {
            content: ''; position: absolute; inset: 10px; border-radius: 50%;
            background: #141418; /* Match card dark interior */
        }
        .progress-content { position: relative; z-index: 2; text-align: center; }

        /* ACTIONS ROW */
        .action-btn {
            background: rgba(255,255,255,0.05); border-radius: 24px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.1s; border: 1px solid transparent;
        }
        .action-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.1); }
        .action-btn.primary { background: rgba(0, 240, 255, 0.1); border-color: rgba(0, 240, 255, 0.3); }

        /* ALIGNMENT HINT (Subtle Text) */
        #align-hint {
            position: absolute; top: 15%; width: 100%; text-align: center;
            font-size: 12px; letter-spacing: 3px; color: rgba(255,255,255,0.5);
            text-shadow: 0 0 10px black; pointer-events: none;
        }
    </style>
</head>
<body>

    <video id="input-video" playsinline webkit-playsinline></video>
    
    <!-- BACKGROUND ENGINE (Stardust) -->
    <div id="universe"></div>

    <!-- LAYER 1: HOME (SCANNER) -->
    <div id="layer-home" class="layer active">
        <!-- Header -->
        <div class="absolute top-12 left-0 w-full text-center">
            <h1 class="text-3xl font-bold text-white tracking-tight drop-shadow-lg">TENKI</h1>
            <p class="text-[10px] text-cyan-400 tracking-[6px] mt-1">QUANTUM SENSING</p>
        </div>

        <!-- Alignment Hint (v18.0 Style) -->
        <div id="align-hint">ALIGN SENSORS</div>

        <!-- Fingerprint Button -->
        <div class="fingerprint-container" id="scan-container">
            <div id="scan-trigger" class="fingerprint-sensor">
                <i data-lucide="fingerprint" class="w-10 h-10 text-white opacity-80"></i>
            </div>
            <div id="instruction" class="mt-6 text-[10px] tracking-[3px] text-gray-500 font-mono transition-all">
                HOLD TO SCAN
            </div>
        </div>
    </div>

    <!-- LAYER 2: DASHBOARD (GO CLUB STYLE) -->
    <div id="layer-result" class="layer hidden-layer">
        
        <!-- Header -->
        <div class="flex justify-between items-end mb-6">
            <div>
                <div class="text-xs text-gray-400 mb-1">Dec 16, 2025</div>
                <h2 class="text-2xl font-bold text-white">Your Energy</h2>
            </div>
            <div class="px-3 py-1 rounded-full bg-white/10 border border-white/10 flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                <span class="text-[10px] font-bold tracking-wider">LIVE</span>
            </div>
        </div>

        <!-- Bento Grid -->
        <div class="bento-grid">
            
            <!-- 1. MAIN SCORE CARD (Wide) -->
            <div class="bento-card col-span-2 card-glow-cyan flex items-center justify-between">
                <div>
                    <div class="txt-label mb-2">ERI SCORE</div>
                    <div class="text-5xl font-black text-white tracking-tighter" id="res-score">--</div>
                    <div class="mt-2 text-sm font-bold text-cyan-400" id="res-status">CALCULATING...</div>
                </div>
                <!-- Circular Progress Widget -->
                <div class="progress-circle" id="score-circle" style="--pct: 0deg">
                    <div class="progress-content">
                        <i data-lucide="activity" class="w-6 h-6 text-white mx-auto mb-1"></i>
                        <div class="text-[10px] text-gray-400">REAL-TIME</div>
                    </div>
                </div>
            </div>

            <!-- 2. HRV STAT -->
            <div class="bento-card flex flex-col justify-between">
                <div class="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center mb-2">
                    <i data-lucide="heart-pulse" class="w-4 h-4 text-purple-400"></i>
                </div>
                <div>
                    <div class="txt-val" id="res-hrv">--</div>
                    <div class="txt-label mt-1">HRV (ms)</div>
                </div>
            </div>

            <!-- 3. BREATH STAT -->
            <div class="bento-card flex flex-col justify-between">
                <div class="w-8 h-8 rounded-full bg-cyan-500/20 flex items-center justify-center mb-2">
                    <i data-lucide="wind" class="w-4 h-4 text-cyan-400"></i>
                </div>
                <div>
                    <div class="txt-val" id="res-resp">--</div>
                    <div class="txt-label mt-1">Breaths/min</div>
                </div>
            </div>

            <!-- 4. STRATEGY (Wide) -->
            <div class="bento-card col-span-2 card-glow-purple flex flex-col justify-center">
                <div class="flex items-center gap-2 mb-2">
                    <i data-lucide="crosshair" class="w-4 h-4 text-gray-400"></i>
                    <span class="txt-label text-gray-400">STRATEGY UNLOCKED</span>
                </div>
                <div class="text-xl font-bold text-white">
                    Failed Breakdown <span class="text-gray-500">&</span> Scalp
                </div>
            </div>

            <!-- 5. ACTIONS (Bottom) -->
            <button onclick="App.startEnhancedScan()" class="action-btn col-span-2 py-4 border border-white/10">
                <span class="text-xs font-bold tracking-widest text-gray-300">ENHANCED SCAN (15s)</span>
                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-500"></i>
            </button>
            
            <button onclick="App.reset()" class="action-btn primary py-6">
                <i data-lucide="refresh-ccw" class="w-6 h-6 text-cyan-400"></i>
            </button>
            
            <button class="action-btn py-6">
                <i data-lucide="bar-chart-2" class="w-6 h-6 text-white"></i>
            </button>
        </div>
    </div>

    <script>
        lucide.createIcons();

        const App = {
            config: { particleCount: 8000 },
            state: { 
                isScanning: false, 
                mouthOpen: 0, 
                headRot: {x:0, y:0}, 
                energy: 0 
            },

            init: function() {
                this.initThree();
                this.initAI();
                this.initEvents();
            },

            // --- 1. THREE.JS ENGINE (v18.0 STARDUST) ---
            initThree: function() {
                const container = document.getElementById('universe');
                this.scene = new THREE.Scene();
                this.scene.fog = new THREE.FogExp2(0x050505, 0.02); // Deep black fog
                
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
                this.camera.position.z = 5;
                
                this.renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                container.appendChild(this.renderer.domElement);

                // Shader Material (Soul Effect)
                const vertexShader = `
                    attribute float size; attribute float random; uniform float uTime; uniform float uScale; varying float vRandom;
                    void main() { vRandom = random; vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
                    gl_PointSize = (15.0 * size * uScale) * (5.0 / -mvPosition.z); gl_Position = projectionMatrix * mvPosition; }
                `;
                const fragmentShader = `
                    uniform vec3 color; varying float vRandom;
                    void main() { vec2 xy = gl_PointCoord.xy - vec2(0.5); float ll = length(xy); if(ll>0.5) discard;
                    float strength = pow((0.5-ll)*2.0, 2.0); gl_FragColor = vec4(color, strength*0.9); }
                `;

                const geometry = new THREE.BufferGeometry();
                const pos = [], orig = [], rnd = [], sizes = [];
                const phi = Math.PI * (3. - Math.sqrt(5.));

                for (let i = 0; i < this.config.particleCount; i++) {
                    const y = 1 - (i / (this.config.particleCount - 1)) * 2;
                    const radius = Math.sqrt(1 - y * y);
                    const theta = phi * i;
                    const r = 2.5; 
                    const x = Math.cos(theta) * radius * r;
                    const z = Math.sin(theta) * radius * r;
                    pos.push(x, y * r, z); orig.push(x, y * r, z);
                    rnd.push(Math.random()); sizes.push(0.5 + Math.random() * 1.5);
                }
                
                geometry.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
                geometry.setAttribute('originalPosition', new THREE.Float32BufferAttribute(orig, 3));
                geometry.setAttribute('random', new THREE.Float32BufferAttribute(rnd, 1));
                geometry.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));

                this.material = new THREE.ShaderMaterial({
                    uniforms: {
                        uTime: { value: 0 },
                        uScale: { value: 1.0 },
                        color: { value: new THREE.Color(0x0088ff) }
                    },
                    vertexShader, fragmentShader, transparent: true, depthWrite: false, blending: THREE.AdditiveBlending
                });

                this.cloud = new THREE.Points(geometry, this.material);
                this.scene.add(this.cloud);
                this.animate();
            },

            animate: function() {
                requestAnimationFrame(() => this.animate());
                const time = Date.now() * 0.001;
                this.material.uniforms.uTime.value = time;
                
                // Head Rotation Influence
                this.cloud.rotation.y += 0.002 + (this.state.headRot.y * 0.05);
                this.cloud.rotation.x += (this.state.headRot.x * 0.05);

                // Energy Expansion Logic
                let targetEnergy = 0.2;
                if (this.state.mouthOpen > 0.1) targetEnergy += this.state.mouthOpen * 3.0;
                if (this.state.isScanning) targetEnergy = 4.0;
                this.state.energy += (targetEnergy - this.state.energy) * 0.1;

                const positions = this.cloud.geometry.attributes.position.array;
                const originals = this.cloud.geometry.attributes.originalPosition.array;
                const rnd = this.cloud.geometry.attributes.random.array;

                for (let i = 0; i < this.config.particleCount; i++) {
                    const idx = i * 3;
                    const ox = originals[idx], oy = originals[idx+1], oz = originals[idx+2];
                    const noise = Math.sin(time * 2 + rnd[i] * 10) * this.state.energy * 0.1;
                    const expansion = 1 + (this.state.mouthOpen * 0.2);
                    positions[idx] = ox * expansion + (ox * noise);
                    positions[idx+1] = oy * expansion + (oy * noise);
                    positions[idx+2] = oz * expansion + (oz * noise);
                }
                this.cloud.geometry.attributes.position.needsUpdate = true;

                // Color Reaction
                if (this.state.isScanning) {
                    this.material.uniforms.color.value.setHex(0x00F0FF); // Scan Cyan
                    this.material.uniforms.uScale.value = 1.5;
                } else {
                    this.material.uniforms.color.value.setHex(0x112233); // Idle Blue
                    this.material.uniforms.uScale.value = 0.8;
                }
                this.renderer.render(this.scene, this.camera);
            },

            // --- 2. AI VISION ---
            initAI: function() {
                const video = document.getElementById('input-video');
                const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
                faceMesh.setOptions({maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5});
                
                faceMesh.onResults((res) => {
                    const hint = document.getElementById('align-hint');
                    if (res.multiFaceLandmarks && res.multiFaceLandmarks.length > 0) {
                        hint.innerText = "SENSORS ALIGNED"; hint.style.color = "#00F0FF";
                        const lm = res.multiFaceLandmarks[0];
                        // Mirror fix
                        this.state.headRot.x = (lm[1].y - 0.5) * 2;
                        this.state.headRot.y = (lm[1].x - 0.5) * 2;
                        const d = Math.sqrt(Math.pow(lm[13].x-lm[14].x, 2) + Math.pow(lm[13].y-lm[14].y, 2));
                        this.state.mouthOpen += ((d*6) - this.state.mouthOpen) * 0.2;
                    } else {
                        hint.innerText = "ALIGN SENSORS"; hint.style.color = "rgba(255,255,255,0.5)";
                    }
                });
                
                const camera = new Camera(video, {
                    onFrame: async () => await faceMesh.send({image: video}),
                    width: 640, height: 480
                });
                camera.start();
            },

            // --- 3. INTERACTION (V18.0 LOGIC + GO CLUB RESULT) ---
            initEvents: function() {
                const btn = document.getElementById('scan-trigger');
                
                const startScan = (e) => {
                    // Critical Fix for magnifying glass
                    e.preventDefault();
                    if(this.state.isScanning) return;
                    
                    this.state.isScanning = true;
                    btn.classList.add('active');
                    document.getElementById('instruction').innerText = "ANALYZING...";
                    if(navigator.vibrate) navigator.vibrate(50);

                    // 2-Second Scan (v18.0 Default)
                    let progress = 0;
                    this.scanInterval = setInterval(() => {
                        progress += 2; // Fast scan
                        if (progress >= 100) this.finishScan();
                    }, 40);
                };

                const endScan = (e) => {
                    // Only interrupt if result isn't showing
                    if(document.getElementById('layer-result').classList.contains('active')) return;
                    
                    if(!this.state.isScanning) return;
                    this.state.isScanning = false;
                    clearInterval(this.scanInterval);
                    btn.classList.remove('active');
                    document.getElementById('instruction').innerText = "HOLD TO SCAN";
                };

                btn.addEventListener('mousedown', startScan);
                btn.addEventListener('touchstart', startScan, {passive: false});
                
                // Use window listeners to catch drag-off
                window.addEventListener('mouseup', endScan);
                window.addEventListener('touchend', endScan);
            },

            finishScan: function() {
                clearInterval(this.scanInterval);
                this.state.isScanning = false;
                if(navigator.vibrate) navigator.vibrate([100, 50, 100]);

                // TRANSITION TO DASHBOARD
                const home = document.getElementById('layer-home');
                const result = document.getElementById('layer-result');
                
                home.classList.remove('active');
                home.classList.add('hidden-layer');
                
                setTimeout(() => {
                    result.classList.remove('hidden-layer');
                    result.classList.add('active');
                    this.animateNumbers();
                }, 200);
            },

            animateNumbers: function() {
                // Calculate Mock Scores (v18.0 Logic)
                const movement = Math.abs(this.state.headRot.x) + Math.abs(this.state.headRot.y);
                const score = Math.floor(Math.max(20, Math.min(99, 100 - (movement * 100))));
                
                // Animate ERI Score
                const scoreEl = document.getElementById('res-score');
                const circle = document.getElementById('score-circle');
                let cur = 0;
                const timer = setInterval(() => {
                    cur += 2;
                    if(cur >= score) {
                        cur = score;
                        clearInterval(timer);
                        
                        // Set Status
                        const st = document.getElementById('res-status');
                        if(score > 80) { st.innerText = "ZEN MASTER"; st.style.color = "#00FF88"; }
                        else if(score > 50) { st.innerText = "BALANCED"; st.style.color = "#00F0FF"; }
                        else { st.innerText = "HIGH STRESS"; st.style.color = "#FF3333"; }
                    }
                    scoreEl.innerText = cur;
                    // Update Circle Gradient Rotation
                    const deg = (cur / 100) * 360;
                    circle.style.setProperty('--pct', deg + 'deg');
                }, 20);

                // Static Stats
                document.getElementById('res-hrv').innerText = Math.floor(Math.random() * 50 + 30);
                document.getElementById('res-resp').innerText = Math.floor(Math.random() * 6 + 12);
            },

            startEnhancedScan: function() {
                alert("Entering 15s Deep Scan Mode...");
            },

            reset: function() {
                // Back to Home
                const home = document.getElementById('layer-home');
                const result = document.getElementById('layer-result');
                
                result.classList.remove('active');
                result.classList.add('hidden-layer');
                
                setTimeout(() => {
                    home.classList.remove('hidden-layer');
                    home.classList.add('active');
                    
                    document.getElementById('scan-trigger').classList.remove('active');
                    document.getElementById('instruction').innerText = "HOLD TO SCAN";
                    document.getElementById('res-score').innerText = "--";
                    document.getElementById('score-circle').style.setProperty('--pct', '0deg');
                }, 500);
            }
        };

        window.onload = () => App.init();
        window.onresize = () => {
            App.camera.aspect = window.innerWidth / window.innerHeight;
            App.camera.updateProjectionMatrix();
            App.renderer.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>
