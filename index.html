<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TENKI PRO v5.1 - Ultimate Fusion</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --bg-deep: #050510;
            --plasma-cyan: #23F3D4;
            --lava-orange: #FF5F1F;
            --stardust-purple: #9575FF;
            --glass-bg: rgba(20, 20, 30, 0.75);
            --glass-border: rgba(255, 255, 255, 0.08);
            --go-gold: #D4AF37; /* Go Club Luxury Accent */
        }

        body {
            background: var(--bg-deep);
            color: white;
            font-family: 'Space Mono', monospace;
            overflow: hidden;
            width: 100vw; height: 100vh;
            margin: 0; padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        .font-serif-human { font-family: 'Playfair Display', serif; }
        .font-mono-tech { font-family: 'Space Mono', monospace; }

        /* 1. Privacy & Background Layer */
        #input-video { position: fixed; top: -9999px; left: -9999px; opacity: 0; pointer-events: none; }
        
        #universe {
            position: absolute; inset: 0; z-index: 1;
            background: radial-gradient(circle at center, #151520 0%, #000000 100%);
            transition: opacity 1s ease, filter 1s ease;
        }
        #universe.dimmed { opacity: 0.5; filter: blur(8px); }

        /* 2. HUD Layer */
        #hud-layer {
            position: absolute; inset: 0; z-index: 10;
            pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 24px;
            transition: opacity 0.5s ease;
        }
        #hud-layer.hidden-ui { opacity: 0; pointer-events: none; }

        /* 3. Dashboard Layer (Go Club Style) */
        #dashboard-layer {
            position: absolute; inset: 0; z-index: 50;
            background: transparent;
            display: flex; flex-direction: column;
            padding: 20px 20px 100px 20px; /* Bottom padding for dock */
            overflow-y: auto; opacity: 0; pointer-events: none;
            transform: translateY(20px);
            transition: opacity 0.8s ease, transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        #dashboard-layer.show { opacity: 1; pointer-events: auto; transform: translateY(0); }

        /* UI Components */
        .bento-card {
            background: var(--glass-bg); 
            border: 1px solid var(--glass-border);
            border-radius: 20px; 
            padding: 20px;
            backdrop-filter: blur(40px);
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; position: relative; overflow: hidden;
            transition: transform 0.2s;
        }
        .bento-card:active { transform: scale(0.99); }

        /* Friction Modal */
        #friction-modal {
            position: absolute; inset: 0; z-index: 100;
            background: rgba(5, 5, 10, 0.9); backdrop-filter: blur(15px);
            display: flex; flex-direction: column; justify-content: center; items-center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #friction-modal.show { opacity: 1; pointer-events: auto; }
        .friction-border { border: 1px solid var(--lava-orange); box-shadow: 0 0 30px rgba(255, 95, 31, 0.2); animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 20px rgba(255, 95, 31, 0.1); } 50% { box-shadow: 0 0 40px rgba(255, 95, 31, 0.3); } }

        /* Neural Balance Map */
        .balance-track {
            height: 2px; width: 100%; background: linear-gradient(90deg, var(--plasma-cyan), #333 50%, var(--lava-orange));
            position: relative; margin-top: 16px; margin-bottom: 8px;
        }
        .balance-anchor {
            width: 10px; height: 10px; border-radius: 50%; background: white;
            box-shadow: 0 0 12px rgba(255,255,255,0.8); position: absolute; top: -4px; left: 50%;
            transform: translateX(-50%); transition: left 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* Fingerprint Sensor */
        .fingerprint-sensor {
            pointer-events: auto; position: relative;
            width: 80px; height: 80px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.15);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(5px);
        }
        .fingerprint-sensor.active {
            transform: scale(1.1); border-color: var(--stardust-purple);
            background: rgba(149, 117, 255, 0.15); box-shadow: 0 0 50px rgba(149, 117, 255, 0.3);
        }

        /* Typography & Colors */
        .text-plasma { color: var(--plasma-cyan); }
        .text-lava { color: var(--lava-orange); }
        .text-gold { color: var(--go-gold); }
        
        /* Dock */
        .dock-container {
            position: fixed; bottom: 30px; left: 20px; right: 20px; height: 64px;
            background: #111; border: 1px solid rgba(255,255,255,0.1); border-radius: 32px;
            display: flex; align-items: center; justify-content: space-between; padding: 0 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            transform: translateY(100px); transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #dashboard-layer.show .dock-container { transform: translateY(0); }
    </style>
</head>
<body>

    <video id="input-video" playsinline></video>
    <div id="universe"></div>

    <!-- Friction Engine Modal -->
    <div id="friction-modal" class="p-6">
        <div class="bento-card friction-border w-full max-w-sm text-center p-8 bg-black/80">
            <div class="text-lava text-4xl mb-6 mx-auto"><i data-lucide="triangle-alert"></i></div>
            <h2 class="text-xl font-bold text-white mb-2 font-mono-tech">FRICTION PROTOCOL</h2>
            <p class="text-xs text-gray-400 font-mono-tech mb-8 leading-relaxed">
                TEI SCORE LOW (â‰¤62)<br>
                High SNS Activation Detected.<br>
                Pause required before execution.
            </p>
            <div class="text-5xl font-bold text-white mb-8 font-mono-tech" id="friction-timer">5</div>
            <button id="friction-override-btn" class="w-full py-4 rounded-xl bg-white/5 border border-white/10 text-gray-600 text-[10px] font-bold tracking-[2px] cursor-not-allowed transition-all" disabled>
                COOLDOWN ACTIVE
            </button>
        </div>
    </div>

    <!-- HUD Layer (Entry) -->
    <div id="hud-layer">
        <div class="flex justify-between items-start">
            <div>
                <div class="text-xl font-bold tracking-[6px] text-white font-mono-tech">TENKI</div>
                <div class="text-[8px] text-purple-300 tracking-widest mt-1 font-mono-tech">PRO_v5.1_MANCINI</div>
            </div>
            <div class="text-right flex flex-col items-end">
                <div id="connection-status" class="text-[10px] text-gray-400 border border-white/10 px-2 py-1 rounded mb-2 font-mono-tech">
                    VISION READY
                </div>
            </div>
        </div>

        <div class="flex flex-col items-center pb-20">
            <div id="scan-trigger" class="fingerprint-sensor">
                <i data-lucide="fingerprint" class="w-8 h-8 text-white/80"></i>
            </div>
            <div id="instruction" class="mt-8 text-[10px] tracking-[4px] text-gray-500 font-mono-tech transition-all duration-300">
                INITIATE SCAN
            </div>
        </div>
    </div>

    <!-- Dashboard Layer (Go Club Interface) -->
    <div id="dashboard-layer">
        
        <!-- Top Bar -->
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-gray-500" id="status-dot"></div>
                <span class="text-[10px] font-bold text-gray-400 tracking-wider font-mono-tech" id="status-text">OFFLINE</span>
            </div>
            <div id="privacy-badge" class="h-7 px-3 rounded-full bg-green-500/10 border border-green-500/30 flex items-center gap-2 transition-all duration-500">
                <i data-lucide="shield-check" class="w-3 h-3 text-green-400"></i>
                <span class="text-[9px] text-green-400 font-mono-tech tracking-wide">SECURE</span>
            </div>
        </div>

        <!-- (A) Main TEI Card + Plasma Filament -->
        <div class="bento-card mb-4 relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-4 opacity-30"><i data-lucide="orbit" class="w-24 h-24 text-white"></i></div>
            
            <div class="flex justify-between items-start mb-6 z-10">
                <div>
                    <div class="text-[10px] text-gray-400 font-mono-tech tracking-widest mb-1">TEI SCORE</div>
                    <div class="text-6xl font-bold text-white font-mono-tech tracking-tighter" id="dash-score">00</div>
                </div>
                <!-- Plasma Canvas (Visualizing Neural Jitter) -->
                <div class="w-24 h-16 opacity-80">
                    <canvas id="plasma-canvas" width="100" height="60" class="w-full h-full"></canvas>
                </div>
            </div>

            <!-- Neural Balance Map -->
            <div class="z-10">
                <div class="flex justify-between text-[9px] font-bold text-gray-500 mb-1 font-mono-tech">
                    <span class="text-plasma">PNS (BRAKE)</span>
                    <span class="text-lava">SNS (GAS)</span>
                </div>
                <div class="balance-track">
                    <div id="balance-dot" class="balance-anchor"></div>
                </div>
                <div class="text-[9px] text-gray-500 text-center font-serif-human italic mt-1" id="balance-msg">System Balanced</div>
            </div>
        </div>

        <!-- (B) Metrics Grid -->
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="bento-card justify-between h-28">
                <div class="flex justify-between items-start">
                    <i data-lucide="activity" class="w-4 h-4 text-purple-400"></i>
                    <span class="text-[9px] text-gray-500 font-mono-tech">HRV (ms)</span>
                </div>
                <div class="text-2xl font-bold text-white font-mono-tech" id="metric-hrv">--</div>
                <div class="w-full h-1 bg-white/10 rounded-full overflow-hidden">
                    <div id="hrv-bar" class="h-full bg-purple-500 w-0 transition-all duration-1000"></div>
                </div>
            </div>
            
            <div class="bento-card justify-between h-28">
                <div class="flex justify-between items-start">
                    <i data-lucide="layers" class="w-4 h-4 text-cyan-400"></i>
                    <span class="text-[9px] text-gray-500 font-mono-tech">POLES</span>
                </div>
                <div class="text-2xl font-bold text-white font-mono-tech" id="pole-count">0</div>
                <div class="text-[9px] text-gray-500">Samples Locked</div>
            </div>
        </div>

        <!-- (C) Quote Card (Go Club Style) -->
        <div class="bento-card mb-4 bg-gradient-to-br from-gray-900 to-black border-white/10">
            <div class="flex justify-center mb-3">
                <i data-lucide="quote" class="w-4 h-4 text-gold opacity-80"></i>
            </div>
            <div class="text-center">
                <p class="text-lg font-serif-human text-white/90 leading-relaxed italic" id="dash-quote">
                    "The market is a mirror of your mind."
                </p>
                <div class="w-8 h-[1px] bg-gold/50 mx-auto my-3"></div>
                <p class="text-[9px] text-gold/70 font-mono-tech tracking-widest uppercase" id="quote-author">Mancini Rule #1</p>
            </div>
        </div>

        <!-- (D) Mancini Timer (Thin Line) -->
        <div class="bento-card p-0 flex-row items-stretch h-16 overflow-hidden mb-24">
            <div class="flex-1 flex flex-col justify-center px-6">
                <span class="text-[9px] text-gray-500 font-mono-tech mb-1">MANCINI FBD TIMER</span>
                <span class="text-2xl font-mono-tech text-white tracking-widest" id="timer-display">03:00</span>
            </div>
            <button id="timer-btn" class="w-20 bg-white/5 border-l border-white/10 hover:bg-white/10 active:bg-white/20 transition-colors flex items-center justify-center">
                <i data-lucide="play" class="w-5 h-5 text-white" id="timer-icon"></i>
            </button>
        </div>

        <!-- Bottom Dock -->
        <div class="dock-container z-50">
            <div class="w-10 h-10 rounded-full flex items-center justify-center text-gray-400 hover:text-white transition-colors" onclick="app.reset()">
                <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
            </div>
            <div class="dock-main-action px-6 h-10 rounded-full bg-white/10 border border-white/10 flex items-center justify-center text-[10px] font-bold tracking-widest text-white">
                SYSTEM ACTIVE
            </div>
            <div class="w-10 h-10 rounded-full flex items-center justify-center text-gray-400 hover:text-white transition-colors">
                <i data-lucide="settings-2" class="w-5 h-5"></i>
            </div>
        </div>

    </div>

    <!-- LOGIC CORE (v24.2 + v5.0 Fusion) -->
    <script>
        // --- 1. Statistical Engine (Pole Logic) ---
        const TenkiEngine = {
            calculatePole: function(buffer) {
                if (!buffer || buffer.length === 0) return { score: 50, stability: 0, energy: 0.5 };
                
                // Stability (Head Movement Variance)
                let sumHead = 0; buffer.forEach(s => sumHead += (Math.abs(s.headRot.x) + Math.abs(s.headRot.y)));
                const meanHead = sumHead / buffer.length;
                let varHead = 0; buffer.forEach(s => { let d = (Math.abs(s.headRot.x) + Math.abs(s.headRot.y)) - meanHead; varHead += d*d; });
                const stdDev = Math.sqrt(varHead / buffer.length);
                const stability = Math.max(0, 1 - (stdDev * 5)); 

                // Energy (Audio + Mouth)
                let sumEn = 0; buffer.forEach(s => sumEn += (s.audioData/255) + s.mouthOpen);
                const energy = Math.min(1, (sumEn / buffer.length) * 2);

                // Score Calculation
                const rawScore = 60 + (stability * 30) + (energy * 10);
                const score = Math.floor(Math.max(10, Math.min(99, rawScore)));

                // Neural Balance (0=PNS/Calm, 1=SNS/Stress)
                const balance = 0.5 + (energy * 0.3) - (stability * 0.3);

                return { score, balance, stability, energy, samples: buffer.length };
            },
            
            getQuote: function(score) {
                if(score > 80) return { q: "Flow is not forced; it is allowed.", a: "High Coherence" };
                if(score > 62) return { q: "Patience is the currency of the disciplined.", a: "Balanced State" };
                return { q: "Do not trade from a place of want.", a: "Friction Triggered" };
            }
        };

        // --- 2. Plasma Filament Class (Visuals) ---
        class PlasmaFilament {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.phase = 0;
                this.stressLevel = 0.5;
            }
            update(stress, isActive) {
                // If inactive (simulation), keep moving gently. If active, react to stress.
                const target = isActive ? stress : 0.3 + Math.sin(Date.now()*0.002)*0.1;
                this.stressLevel += (target - this.stressLevel) * 0.1;
            }
            draw() {
                const { width: w, height: h } = this.canvas;
                this.ctx.clearRect(0, 0, w, h);
                this.ctx.beginPath();
                
                const jitter = this.stressLevel * 8;
                this.phase += 0.1 + (this.stressLevel * 0.1);

                for (let x = 0; x <= w; x += 2) {
                    const base = Math.sin(x * 0.1 + this.phase) * (5 + this.stressLevel * 10);
                    const noise = (Math.random() - 0.5) * jitter;
                    this.ctx.lineTo(x, h/2 + base + noise);
                }
                
                // Color shifts from Cyan (Calm) to Orange (Stress)
                this.ctx.strokeStyle = this.stressLevel > 0.6 ? '#FF5F1F' : '#23F3D4';
                this.ctx.lineWidth = 2;
                this.ctx.shadowBlur = 10;
                this.ctx.shadowColor = this.ctx.strokeStyle;
                this.ctx.stroke();
            }
        }

        // --- 3. Main Application ---
        lucide.createIcons();
        
        const app = {
            config: { particleCount: 7000 },
            state: { 
                isScanning: false, isSensorActive: false,
                headRot: {x:0, y:0}, mouthOpen: 0, audioData: 0,
                scanBuffer: [], result: null,
                timerRunning: false, timeLeft: 180
            },
            plasma: null,

            init: function() {
                this.initThree();
                this.initEvents();
                this.plasma = new PlasmaFilament('plasma-canvas');
                
                // Date Init
                const d = new Date();
                // document.getElementById('dash-date').innerText = d.toLocaleDateString('en-US', {month:'short', day:'numeric'}).toUpperCase();
            },

            // --- Three.js Engine (Stardust Soul) ---
            initThree: function() {
                const container = document.getElementById('universe');
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
                this.camera.position.z = 5;
                this.renderer = new THREE.WebGLRenderer({ alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                container.appendChild(this.renderer.domElement);

                const geo = new THREE.BufferGeometry();
                const pos = new Float32Array(this.config.particleCount * 3);
                for(let i=0; i<this.config.particleCount*3; i++) pos[i] = (Math.random()-0.5)*10;
                geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
                const mat = new THREE.PointsMaterial({ size: 0.06, color: 0x9575FF, transparent: true, opacity: 0.7 });
                this.cloud = new THREE.Points(geo, mat);
                this.scene.add(this.cloud);
                this.animate();
            },

            // --- Animation Loop (The Heartbeat) ---
            animate: function() {
                requestAnimationFrame(() => this.animate());
                
                const time = Date.now() * 0.001;
                
                // 1. Logic: Real or Simulation?
                if (!this.state.isSensorActive) {
                    // Privacy Mode: Simulation Logic
                    // Use Sine waves to create a "breathing" effect so particles don't freeze
                    this.state.headRot.x = Math.sin(time * 0.5) * 0.15;
                    this.state.headRot.y = Math.cos(time * 0.3) * 0.15;
                    this.state.mouthOpen = 0.05 + Math.sin(time)*0.02;
                    // Plasma also breathes
                    if(this.plasma) this.plasma.update(0.3, false); 
                } else {
                    // Real Data Logic
                    if (this.analyser) {
                        this.dataArray = new Uint8Array(64);
                        this.analyser.getByteFrequencyData(this.dataArray);
                        let sum=0; this.dataArray.forEach(v=>sum+=v);
                        this.state.audioData = sum/64;
                    }
                    // Calculate immediate stress for plasma
                    let instStress = 0.2 + (this.state.audioData/255) + Math.abs(this.state.headRot.x);
                    if(this.state.isScanning) instStress = 0.8; // High jitter when scanning
                    if(this.plasma) this.plasma.update(instStress, true);
                }

                // 2. Render Visuals
                this.cloud.rotation.y += 0.0015 + (this.state.headRot.y * 0.05);
                this.cloud.rotation.x += (this.state.headRot.x * 0.05);
                this.renderer.render(this.scene, this.camera);
                if(this.plasma) this.plasma.draw();
            },

            // --- Sensor Logic (Privacy Core) ---
            startSensors: async function() {
                try {
                    this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = this.audioCtx.createAnalyser();
                    this.stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
                    const src = this.audioCtx.createMediaStreamSource(this.stream);
                    src.connect(this.analyser);
                    
                    this.initAI(this.stream);
                    this.state.isSensorActive = true;
                    this.updatePrivacyUI(false);
                } catch(e) { console.error(e); }
            },

            stopSensors: function() {
                if(this.stream) this.stream.getTracks().forEach(t=>t.stop());
                if(this.audioCtx) this.audioCtx.close();
                this.state.isSensorActive = false;
                this.updatePrivacyUI(true);
            },

            updatePrivacyUI: function(isSecure) {
                const el = document.getElementById('privacy-badge');
                if(!el) return;
                if(isSecure) {
                    el.className = "h-7 px-3 rounded-full bg-green-500/10 border border-green-500/30 flex items-center gap-2 transition-all duration-500";
                    el.innerHTML = `<i data-lucide="shield-check" class="w-3 h-3 text-green-400"></i><span class="text-[9px] text-green-400 font-mono-tech tracking-wide">SECURE</span>`;
                } else {
                    el.className = "h-7 px-3 rounded-full bg-red-500/10 border border-red-500/30 flex items-center gap-2 transition-all duration-500";
                    el.innerHTML = `<i data-lucide="radio" class="w-3 h-3 text-red-400 animate-pulse"></i><span class="text-[9px] text-red-400 font-mono-tech tracking-wide">LIVE</span>`;
                }
                lucide.createIcons();
            },

            initAI: function(stream) {
                const video = document.getElementById('input-video');
                video.srcObject = stream;
                const face = new FaceMesh({locateFile:(f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`});
                face.setOptions({maxNumFaces:1, minDetectionConfidence:0.6});
                face.onResults((res) => {
                    if(res.multiFaceLandmarks && res.multiFaceLandmarks.length>0) {
                        const l = res.multiFaceLandmarks[0];
                        this.state.headRot = { x: (l[1].y-0.5)*2, y: (l[1].x-0.5)*2 };
                        const lipH = Math.sqrt(Math.pow(l[13].x-l[14].x,2) + Math.pow(l[13].y-l[14].y,2));
                        this.state.mouthOpen = lipH * 10;
                        
                        if(this.state.isScanning) {
                            this.state.scanBuffer.push({
                                headRot: {...this.state.headRot}, 
                                mouthOpen: this.state.mouthOpen,
                                audioData: this.state.audioData
                            });
                        }
                    }
                });
                const cam = new Camera(video, { onFrame: async()=>{await face.send({image:video})}, width:640, height:480 });
                cam.start();
            },

            // --- Interaction Events ---
            initEvents: function() {
                const btn = document.getElementById('scan-trigger');
                
                const start = (e) => {
                    e.preventDefault();
                    if(!this.state.isSensorActive) {
                        this.startSensors();
                        document.getElementById('instruction').innerText = "HOLD TO SCAN";
                        return;
                    }
                    this.state.isScanning = true;
                    this.state.scanBuffer = [];
                    btn.classList.add('active');
                    document.getElementById('instruction').innerText = "ACQUIRING POLES...";
                    if(navigator.vibrate) navigator.vibrate(50);
                    
                    let p=0;
                    this.scanTimer = setInterval(()=>{
                        p+=2;
                        if(p>=100) this.finishScan();
                    }, 40);
                };
                
                const end = () => {
                    if(!this.state.isScanning) return;
                    this.state.isScanning = false;
                    clearInterval(this.scanTimer);
                    btn.classList.remove('active');
                    document.getElementById('instruction').innerText = "HOLD TO SCAN";
                };

                btn.addEventListener('mousedown', start);
                btn.addEventListener('touchstart', start);
                window.addEventListener('mouseup', end);
                window.addEventListener('touchend', end);
                
                // Timer & Friction
                document.getElementById('timer-btn').onclick = () => this.toggleTimer();
                document.getElementById('friction-override-btn').onclick = () => {
                    document.getElementById('friction-modal').classList.remove('show');
                    this.startTimerLogic();
                };
            },

            finishScan: function() {
                clearInterval(this.scanTimer);
                this.state.isScanning = false;
                
                // Calculate
                this.state.result = TenkiEngine.calculatePole(this.state.scanBuffer);
                this.showDashboard();
            },

            showDashboard: function() {
                document.getElementById('hud-layer').classList.add('hidden-ui');
                document.getElementById('universe').classList.add('dimmed');
                const dash = document.getElementById('dashboard-layer');
                dash.classList.add('show');

                // 1. Pole Counting Animation (Visuals)
                const scoreEl = document.getElementById('dash-score');
                const target = this.state.result.score;
                let cur = 0;
                const roll = setInterval(() => {
                    cur += 2;
                    if(cur >= target) { cur = target; clearInterval(roll); }
                    scoreEl.innerText = cur < 10 ? `0${cur}` : cur;
                    if(cur <= 62) scoreEl.style.color = "var(--lava-orange)";
                    else scoreEl.style.color = "var(--plasma-cyan)";
                }, 20);

                // 2. Metrics & Quote
                document.getElementById('pole-count').innerText = this.state.result.samples;
                const hrvVal = Math.floor(20 + this.state.result.stability * 80);
                document.getElementById('metric-hrv').innerText = hrvVal;
                document.getElementById('hrv-bar').style.width = (this.state.result.stability * 100) + "%";
                
                const quoteData = TenkiEngine.getQuote(target);
                document.getElementById('dash-quote').innerText = `"${quoteData.q}"`;
                document.getElementById('quote-author').innerText = quoteData.a;

                // 3. Balance Map Position
                const balPct = Math.max(0, Math.min(100, this.state.result.balance * 100));
                document.getElementById('balance-dot').style.left = balPct + '%';
                const balMsg = document.getElementById('balance-msg');
                if(balPct > 70) { balMsg.innerText = "Sympathetic Dominance (Stress)"; balMsg.className = "text-[9px] text-center font-serif-human italic mt-1 text-lava"; }
                else if(balPct < 30) { balMsg.innerText = "Parasympathetic (Calm)"; balMsg.className = "text-[9px] text-center font-serif-human italic mt-1 text-plasma"; }

                // 4. Status
                const statDot = document.getElementById('status-dot');
                const statTxt = document.getElementById('status-text');
                if(target > 62) {
                    statDot.className = "w-2 h-2 rounded-full bg-green-500 animate-pulse";
                    statTxt.innerText = "FLOW STATE"; statTxt.style.color = "#23F3D4";
                } else {
                    statDot.className = "w-2 h-2 rounded-full bg-red-500 animate-pulse";
                    statTxt.innerText = "DEFENSIVE"; statTxt.style.color = "#FF5F1F";
                }

                // 5. Privacy: Auto-cut sensors
                setTimeout(() => this.stopSensors(), 600);
            },

            // --- Mancini Timer & Friction ---
            toggleTimer: function() {
                if (this.state.timerRunning) {
                    clearInterval(this.timerInt);
                    this.state.timerRunning = false;
                    document.getElementById('timer-icon').setAttribute('data-lucide', 'play');
                    lucide.createIcons();
                } else {
                    // Check Friction
                    if(this.state.result && this.state.result.score <= 62) {
                        this.triggerFriction();
                    } else {
                        this.startTimerLogic();
                    }
                }
            },

            triggerFriction: function() {
                const modal = document.getElementById('friction-modal');
                const btn = document.getElementById('friction-override-btn');
                const tDisp = document.getElementById('friction-timer');
                modal.classList.add('show');
                
                let t = 5;
                tDisp.innerText = t;
                btn.disabled = true;
                btn.style.opacity = "0.5";
                
                const int = setInterval(() => {
                    t--;
                    tDisp.innerText = t;
                    if(t<=0) {
                        clearInterval(int);
                        btn.disabled = false;
                        btn.style.opacity = "1";
                        btn.style.cursor = "pointer";
                        btn.innerText = "ACKNOWLEDGE & PROCEED";
                        btn.className = "w-full py-4 rounded-xl bg-white text-black text-[10px] font-bold tracking-[2px] transition-all hover:scale-105";
                    }
                }, 1000);
            },

            startTimerLogic: function() {
                this.state.timerRunning = true;
                document.getElementById('timer-icon').setAttribute('data-lucide', 'square'); // stop icon
                lucide.createIcons();
                
                this.state.timeLeft = 180;
                this.timerInt = setInterval(() => {
                    this.state.timeLeft--;
                    const m = Math.floor(this.state.timeLeft / 60);
                    const s = this.state.timeLeft % 60;
                    document.getElementById('timer-display').innerText = 
                        `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                    
                    if(this.state.timeLeft<=0) {
                        clearInterval(this.timerInt);
                        this.state.timerRunning = false;
                        if(navigator.vibrate) navigator.vibrate([200, 200, 200]);
                    }
                }, 1000);
            },

            reset: function() {
                document.getElementById('dashboard-layer').classList.remove('show');
                document.getElementById('hud-layer').classList.remove('hidden-ui');
                document.getElementById('universe').classList.remove('dimmed');
                document.getElementById('scan-trigger').classList.remove('active');
                document.getElementById('instruction').innerText = "INITIATE SCAN";
                document.getElementById('timer-display').innerText = "03:00";
                
                this.state.timerRunning = false;
                clearInterval(this.timerInt);
                // Reset to simulation mode
                this.stopSensors();
            }
        };

        window.onload = () => app.init();
        window.onresize = () => {
            app.camera.aspect = window.innerWidth/window.innerHeight;
            app.camera.updateProjectionMatrix();
            app.renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>
