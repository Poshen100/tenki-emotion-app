<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TENKI v23.0 - Infinity Flow</title>
    
    <!-- Core Engine -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    
    <!-- UI / Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- 1. CORE LAYOUT FIXES (NO CROPPING) --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            --bg-deep: #000000;
            --glass-panel: rgba(20, 20, 25, 0.65);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent-cyan: #00F0FF;
            --accent-purple: #9D00FF;
        }

        body {
            background: var(--bg-deep);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            width: 100%; height: 100dvh; /* Dynamic Viewport Height */
            position: fixed; margin: 0; padding: 0;
            overflow: hidden; touch-action: none;
            user-select: none; -webkit-user-select: none; -webkit-touch-callout: none; /* No magnifying glass */
        }

        #input-video { position: fixed; opacity: 0; pointer-events: none; }
        #universe { position: absolute; inset: 0; z-index: 0; pointer-events: none; }

        /* --- 2. LAYER SYSTEM --- */
        .layer {
            position: absolute; inset: 0; z-index: 10;
            display: flex; flex-direction: column;
            /* Safe Area Padding to prevent cropping */
            padding: calc(env(safe-area-inset-top) + 20px) 24px calc(env(safe-area-inset-bottom) + 30px) 24px;
            opacity: 0; pointer-events: none; transform: scale(0.98);
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .layer.active { opacity: 1; pointer-events: auto; transform: scale(1); }
        .layer.hidden-layer { opacity: 0; transform: scale(1.1); pointer-events: none; filter: blur(10px); }

        /* --- 3. APPLE PAY STYLE ALIGNMENT HINT --- */
        #align-hint-capsule {
            position: absolute; top: 18%; left: 50%; transform: translateX(-50%) translateY(-20px);
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(20px);
            padding: 12px 24px;
            border-radius: 99px;
            border: 1px solid rgba(255,255,255,0.15);
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            opacity: 0; pointer-events: none; transition: all 0.4s ease;
            overflow: hidden; z-index: 50;
        }
        #align-hint-capsule.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        /* The Shimmer Effect */
        #align-hint-capsule::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
            transform: skewX(-20deg); animation: shimmer 2s infinite;
        }
        @keyframes shimmer { 0% { left: -100%; } 100% { left: 200%; } }

        /* --- 4. PPG SCAN BUTTON (OUTER RING) --- */
        .scan-wrapper {
            position: relative; width: 100px; height: 100px;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto;
        }
        
        .fingerprint-btn {
            width: 70px; height: 70px; border-radius: 50%;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s; cursor: pointer; z-index: 2;
        }
        .fingerprint-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.1); }

        /* The SVG Ring */
        .ppg-ring-svg {
            position: absolute; inset: 0; width: 100%; height: 100%; transform: rotate(-90deg); z-index: 1;
        }
        .ppg-circle-track { fill: none; stroke: rgba(255,255,255,0.05); stroke-width: 3; }
        .ppg-circle-fill {
            fill: none; stroke: var(--accent-cyan); stroke-width: 3; stroke-linecap: round;
            stroke-dasharray: 283; stroke-dashoffset: 283; /* 2 * PI * 45 */
            transition: stroke-dashoffset 0s linear; /* Controlled by JS */
        }
        .scanning .ppg-circle-fill {
            transition: stroke-dashoffset 2s linear; /* 2s Scan Time */
            stroke-dashoffset: 0;
        }

        /* --- 5. GALAXY BENTO DASHBOARD --- */
        .bento-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 12px;
            width: 100%;
        }

        .bento-card {
            background: var(--glass-panel);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border);
            border-radius: 28px;
            padding: 20px;
            position: relative; overflow: hidden;
        }

        /* Three Ring Data (The Three Circles) */
        .ring-stat-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;
        }
        .mini-ring {
            width: 60px; height: 60px; position: relative;
            display: flex; align-items: center; justify-content: center;
        }
        .mini-ring svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        .mini-track { stroke: rgba(255,255,255,0.1); stroke-width: 4; fill: none; }
        .mini-fill { 
            stroke-width: 4; fill: none; stroke-linecap: round;
            stroke-dasharray: 157; stroke-dashoffset: 157;
            transition: stroke-dashoffset 1s ease-out;
        }

        .col-span-2 { grid-column: span 2; }
        .text-label { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.4); letter-spacing: 1px; text-transform: uppercase; }
        .text-huge { font-size: 48px; font-weight: 800; color: white; line-height: 1; letter-spacing: -1px; }

    </style>
</head>
<body>
    <video id="input-video" playsinline webkit-playsinline></video>
    <div id="universe"></div>

    <!-- LAYER 1: HOME & SCANNER -->
    <div id="layer-home" class="layer active justify-between">
        
        <!-- Top: Branding -->
        <div class="mt-8 text-center">
            <h1 class="text-3xl font-bold text-white tracking-tight">TENKI</h1>
            <p class="text-[10px] text-cyan-400 tracking-[6px] mt-1">QUANTUM SENSING</p>
        </div>

        <!-- Middle: Smart Alignment Hint (Apple Pay Style) -->
        <!-- This floats and only appears when needed or preparing -->
        <div id="align-hint-capsule">
            <div id="hint-icon-box" class="w-5 h-5 rounded-full bg-cyan-500/20 flex items-center justify-center">
                <i id="hint-icon" data-lucide="scan-face" class="w-3 h-3 text-cyan-400"></i>
            </div>
            <span id="hint-text" class="text-xs font-bold text-white tracking-wide">Ready to Scan</span>
        </div>

        <!-- Bottom: PPG Scan Button -->
        <div class="mb-12 flex flex-col items-center">
            <div class="scan-wrapper" id="scan-wrapper">
                <svg class="ppg-ring-svg" viewBox="0 0 100 100">
                    <circle class="ppg-circle-track" cx="50" cy="50" r="45"></circle>
                    <circle class="ppg-circle-fill" id="ppg-progress" cx="50" cy="50" r="45"></circle>
                </svg>
                <div id="scan-trigger" class="fingerprint-btn">
                    <i data-lucide="fingerprint" class="w-8 h-8 text-white opacity-80"></i>
                </div>
            </div>
            <div id="instruction" class="mt-4 text-[10px] tracking-[2px] text-gray-500 font-mono transition-opacity">
                HOLD TO ANALYZE
            </div>
        </div>
    </div>

    <!-- LAYER 2: RESULT DASHBOARD (GALAXY BENTO) -->
    <div id="layer-result" class="layer hidden-layer">
        
        <!-- Header -->
        <div class="flex justify-between items-center mb-6 mt-2">
            <div>
                <div class="text-xs text-gray-400 mb-1">Today's Energy</div>
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                    <span class="text-sm font-bold text-white">Live Sync</span>
                </div>
            </div>
            <button onclick="App.reset()" class="w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center active:scale-95 transition">
                <i data-lucide="rotate-ccw" class="w-4 h-4 text-gray-400"></i>
            </button>
        </div>

        <!-- Bento Grid -->
        <div class="bento-grid">
            
            <!-- 1. MAIN SCORE (ERI) -->
            <div class="bento-card col-span-2 flex items-center justify-between relative">
                <!-- Galaxy Gradient -->
                <div class="absolute inset-0 bg-gradient-to-r from-cyan-500/10 to-blue-600/10 pointer-events-none"></div>
                
                <div class="relative z-10">
                    <div class="text-label mb-1 text-cyan-400">ERI SCORE</div>
                    <div class="text-huge" id="res-eri">--</div>
                    <div class="text-xs text-gray-400 mt-1" id="res-status">CALCULATING</div>
                </div>

                <!-- Large Ring -->
                <div class="mini-ring" style="width: 80px; height: 80px;">
                    <svg viewBox="0 0 100 100">
                        <circle class="mini-track" cx="50" cy="50" r="45"></circle>
                        <circle class="mini-fill" id="ring-eri" cx="50" cy="50" r="45" stroke="#00F0FF" style="stroke-dasharray: 283; stroke-dashoffset: 283;"></circle>
                    </svg>
                    <i data-lucide="activity" class="absolute w-6 h-6 text-white"></i>
                </div>
            </div>

            <!-- 2. HRV Ring -->
            <div class="bento-card flex flex-col items-center justify-center gap-2">
                <div class="mini-ring">
                    <svg viewBox="0 0 100 100">
                        <circle class="mini-track" cx="50" cy="50" r="45"></circle>
                        <circle class="mini-fill" id="ring-hrv" cx="50" cy="50" r="45" stroke="#9D00FF"></circle>
                    </svg>
                    <div class="absolute text-sm font-bold" id="val-hrv">--</div>
                </div>
                <div class="text-label mt-1">HRV (ms)</div>
            </div>

            <!-- 3. Stability Ring -->
            <div class="bento-card flex flex-col items-center justify-center gap-2">
                <div class="mini-ring">
                    <svg viewBox="0 0 100 100">
                        <circle class="mini-track" cx="50" cy="50" r="45"></circle>
                        <circle class="mini-fill" id="ring-stab" cx="50" cy="50" r="45" stroke="#00FF88"></circle>
                    </svg>
                    <div class="absolute text-sm font-bold" id="val-stab">--</div>
                </div>
                <div class="text-label mt-1">Stability</div>
            </div>

            <!-- 4. Strategy -->
            <div class="bento-card col-span-2 flex flex-col justify-center bg-purple-900/10 border-purple-500/20">
                <div class="flex items-center gap-2 mb-2">
                    <i data-lucide="zap" class="w-3 h-3 text-purple-400"></i>
                    <span class="text-label text-purple-300">Strategy</span>
                </div>
                <div class="text-lg font-bold text-white">
                    Failed Breakdown <span class="text-gray-500">&</span> Scalp
                </div>
            </div>

            <!-- 5. Enhanced Scan -->
            <button onclick="alert('Starting 15s Deep Scan...')" class="bento-card col-span-2 py-4 flex items-center justify-center gap-2 active:scale-95 transition bg-white/5 hover:bg-white/10">
                <span class="text-xs font-bold text-gray-300 tracking-widest">ENHANCED SCAN (15s)</span>
                <i data-lucide="arrow-right" class="w-3 h-3 text-gray-500"></i>
            </button>

        </div>
    </div>

    <script>
        lucide.createIcons();

        const App = {
            state: {
                isScanning: false,
                faceDetected: false,
                hintState: 'idle'
            },
            
            init: function() {
                this.initThree();
                this.initAI();
                this.initEvents();
            },

            // --- 1. SMART ALIGNMENT (THE APPLE PAY LOGIC) ---
            updateHint: function(landmarks) {
                // Don't update hint if already scanning (keep focus)
                if(this.state.isScanning) {
                    this.showHint("Scanning...", "fingerprint", "text-cyan-400");
                    return;
                }

                if (!landmarks) {
                    this.showHint("Find Face", "scan-face", "text-red-400");
                    return;
                }

                // Landmarks: 1=NoseTip, 234=LeftCheek, 454=RightCheek
                const nose = landmarks[1];
                const width = Math.abs(landmarks[234].x - landmarks[454].x);
                const tilt = Math.abs(landmarks[10].x - landmarks[152].x); // Top vs Bottom head

                let msg = "Ready to Scan";
                let icon = "check";
                let color = "text-green-400";

                // Logic Cascade
                if (width < 0.35) {
                    msg = "Move Closer"; icon = "move"; color = "text-yellow-400";
                } else if (nose.x < 0.4) {
                    msg = "Move Right"; icon = "arrow-right"; color = "text-yellow-400";
                } else if (nose.x > 0.6) {
                    msg = "Move Left"; icon = "arrow-left"; color = "text-yellow-400";
                } else if (tilt > 0.1) {
                    msg = "Straighten Head"; icon = "refresh-cw"; color = "text-yellow-400";
                }

                this.showHint(msg, icon, color);
            },

            showHint: function(text, iconName, colorClass) {
                const capsule = document.getElementById('align-hint-capsule');
                const txt = document.getElementById('hint-text');
                const iconBox = document.getElementById('hint-icon-box');
                
                // Only update DOM if changed to prevent flicker
                if (txt.innerText !== text) {
                    txt.innerText = text;
                    iconBox.innerHTML = `<i data-lucide="${iconName}" class="w-3 h-3 ${colorClass}"></i>`;
                    lucide.createIcons();
                    
                    if(text === "Ready to Scan" && navigator.vibrate) navigator.vibrate(20);
                }
                
                // Always show
                capsule.classList.add('show');
            },

            // --- 2. THREE.JS STARDUST ---
            initThree: function() {
                const container = document.getElementById('universe');
                const scene = new THREE.Scene();
                scene.fog = new THREE.FogExp2(0x000000, 0.03);
                
                const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
                camera.position.z = 5;
                
                const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                container.appendChild(renderer.domElement);

                // Galaxy Particles
                const geometry = new THREE.BufferGeometry();
                const pos = [], sizes = [];
                for(let i=0; i<6000; i++) {
                    const r = 4 * Math.sqrt(Math.random());
                    const theta = Math.random() * 2 * Math.PI;
                    pos.push(r * Math.cos(theta), r * Math.sin(theta) * 0.8, (Math.random()-0.5)*2);
                    sizes.push(Math.random());
                }
                geometry.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
                geometry.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));

                const material = new THREE.PointsMaterial({
                    size: 0.04, color: 0x00F0FF, transparent: true, opacity: 0.6, blending: THREE.AdditiveBlending
                });
                const cloud = new THREE.Points(geometry, material);
                scene.add(cloud);

                const animate = () => {
                    requestAnimationFrame(animate);
                    cloud.rotation.z += 0.0005;
                    // Pulse color if scanning
                    if(this.state.isScanning) {
                        const t = Date.now() * 0.005;
                        const s = 1 + Math.sin(t) * 0.2;
                        cloud.scale.set(s,s,s);
                        material.color.setHex(0x9D00FF);
                    } else {
                        cloud.scale.lerp(new THREE.Vector3(1,1,1), 0.1);
                        material.color.setHex(0x00F0FF);
                    }
                    renderer.render(scene, camera);
                };
                animate();
            },

            // --- 3. AI ---
            initAI: function() {
                const video = document.getElementById('input-video');
                const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
                faceMesh.setOptions({maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5});
                
                faceMesh.onResults((res) => {
                    if (res.multiFaceLandmarks && res.multiFaceLandmarks.length > 0) {
                        this.updateHint(res.multiFaceLandmarks[0]);
                    } else {
                        this.updateHint(null);
                    }
                });
                
                const camera = new Camera(video, {
                    onFrame: async () => await faceMesh.send({image: video}),
                    width: 640, height: 480
                });
                camera.start();
            },

            // --- 4. EVENTS & SCAN LOGIC ---
            initEvents: function() {
                const btn = document.getElementById('scan-trigger');
                const wrapper = document.getElementById('scan-wrapper');
                
                const start = (e) => {
                    e.preventDefault();
                    if(this.state.isScanning) return;
                    
                    this.state.isScanning = true;
                    wrapper.classList.add('scanning');
                    document.getElementById('instruction').innerText = "KEEP STILL...";
                    document.getElementById('instruction').style.color = "#00F0FF";
                    if(navigator.vibrate) navigator.vibrate(50);
                    
                    // 2 Seconds Timer
                    this.scanTimer = setTimeout(() => {
                        this.finishScan();
                    }, 2000);
                };

                const end = (e) => {
                    if(!this.state.isScanning) return;
                    // If released before 2s
                    this.state.isScanning = false;
                    clearTimeout(this.scanTimer);
                    wrapper.classList.remove('scanning');
                    document.getElementById('instruction').innerText = "HOLD TO ANALYZE";
                    document.getElementById('instruction').style.color = "gray";
                };

                btn.addEventListener('mousedown', start);
                btn.addEventListener('touchstart', start, {passive: false});
                
                btn.addEventListener('mouseup', end);
                btn.addEventListener('touchend', end);
                btn.addEventListener('mouseleave', end);
            },

            finishScan: function() {
                if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
                
                const home = document.getElementById('layer-home');
                const result = document.getElementById('layer-result');
                const hint = document.getElementById('align-hint-capsule');
                
                hint.classList.remove('show');
                home.classList.remove('active');
                home.classList.add('hidden-layer');
                
                setTimeout(() => {
                    result.classList.remove('hidden-layer');
                    result.classList.add('active');
                    this.animateResults();
                }, 300);
            },

            animateResults: function() {
                // Mock Data
                const score = Math.floor(Math.random() * (95 - 65) + 65);
                const hrv = Math.floor(Math.random() * 40 + 40);
                const stab = Math.floor(Math.random() * 20 + 70);
                
                // 1. Text Animation
                this.countUp('res-eri', score);
                this.countUp('val-hrv', hrv);
                this.countUp('val-stab', stab);
                
                document.getElementById('res-status').innerText = score > 80 ? "PEAK PERFORMANCE" : "BALANCED FLOW";
                
                // 2. Ring Animation (CSS Dashoffset)
                // Full circle = 283 (large) or 157 (small)
                
                setTimeout(() => {
                    // ERI Large Ring
                    const eriOffset = 283 - (score / 100 * 283);
                    document.getElementById('ring-eri').style.strokeDashoffset = eriOffset;
                    
                    // Small Rings
                    const hrvOffset = 157 - ((hrv/100) * 157); // normalized roughly
                    document.getElementById('ring-hrv').style.strokeDashoffset = hrvOffset;
                    
                    const stabOffset = 157 - (stab/100 * 157);
                    document.getElementById('ring-stab').style.strokeDashoffset = stabOffset;
                }, 100);
            },

            countUp: function(id, target) {
                let curr = 0;
                const el = document.getElementById(id);
                const interval = setInterval(() => {
                    curr += 2;
                    if(curr >= target) {
                        curr = target;
                        clearInterval(interval);
                    }
                    el.innerText = curr;
                }, 20);
            },

            reset: function() {
                document.getElementById('layer-result').classList.remove('active');
                document.getElementById('layer-result').classList.add('hidden-layer');
                
                // Reset Rings
                document.getElementById('ring-eri').style.strokeDashoffset = 283;
                document.getElementById('ring-hrv').style.strokeDashoffset = 157;
                document.getElementById('ring-stab').style.strokeDashoffset = 157;
                document.getElementById('res-eri').innerText = "--";
                
                setTimeout(() => {
                    document.getElementById('layer-home').classList.remove('hidden-layer');
                    document.getElementById('layer-home').classList.add('active');
                    document.getElementById('scan-wrapper').classList.remove('scanning');
                    document.getElementById('instruction').innerText = "HOLD TO ANALYZE";
                    document.getElementById('instruction').style.color = "gray";
                    this.state.isScanning = false;
                }, 400);
            }
        };

        window.onload = () => App.init();
        window.onresize = () => {
            // Re-calc viewport height for iOS
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        };
    </script>
</body>
</html>
