<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TENKI v10.5 - AI æƒ…ç·’æª¢æ¸¬ç›¸æ©Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/three@r128/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@r128/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4.1633559619/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.4.1633559619/camera_utils.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; }
        body { 
            font-family: Arial, sans-serif;
            background: #000;
            color: #e0e0e0;
            overflow: hidden;
        }
        .container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #0a0e27 0%, #131729 100%);
        }
        .header {
            background: rgba(10, 14, 39, 0.95);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0, 212, 255, 0.2);
            flex-shrink: 0;
        }
        .logo {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(90deg, #00d4ff, #9d4edd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .btn {
            padding: 10px 20px;
            background: linear-gradient(90deg, #00d4ff, #9d4edd);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }
        .main {
            flex: 1;
            display: flex;
            gap: 0;
            min-height: 0;
        }
        .video-section {
            flex: 1;
            background: #000;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 0;
        }
        video {
            display: none;
        }
        #glContainer {
            width: 100%;
            height: 100%;
            position: relative;
        }
        .sidebar {
            width: 350px;
            background: rgba(10, 14, 39, 0.95);
            border-left: 1px solid rgba(0, 212, 255, 0.2);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            flex-shrink: 0;
        }
        .section-title {
            font-size: 12px;
            font-weight: bold;
            color: #00d4ff;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            border-bottom: 2px solid rgba(0, 212, 255, 0.3);
            padding-bottom: 8px;
        }
        .info-panel {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            padding: 16px;
        }
        .info-label {
            color: #00d4ff;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .info-value {
            color: #e0e0e0;
            font-size: 18px;
        }
        .fps-counter {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #00d4ff;
            border-radius: 8px;
            padding: 10px 15px;
            font-family: monospace;
            font-size: 12px;
            color: #00d4ff;
            z-index: 100;
        }
        .results-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0e27, #131729);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }
        .results-screen.active {
            display: flex;
        }
        .results-content {
            text-align: center;
            max-width: 600px;
        }
        .emotion-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }
        .emotion-name {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            background: linear-gradient(90deg, #00d4ff, #9d4edd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .emotion-desc {
            font-size: 18px;
            margin-bottom: 30px;
            color: #a0a0a0;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 212, 255, 0.2);
            border-top: 3px solid #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">TENKI v10.5</div>
            <button class="btn" onclick="appState.startCamera()">ğŸ¥ å•Ÿå‹•ç›¸æ©Ÿ</button>
        </div>
        <div class="main">
            <div class="video-section">
                <video id="video"></video>
                <div id="glContainer"></div>
                <div class="fps-counter" id="fpsCounter">FPS: 0</div>
            </div>
            <div class="sidebar">
                <div>
                    <div class="section-title">ğŸ“Š è¿½è¹¤ç‹€æ…‹</div>
                    <div class="info-panel">
                        <div class="info-label">æª¢æ¸¬é»æ•¸</div>
                        <div class="info-value" id="landmarkCount">0 / 468</div>
                    </div>
                </div>
                <div>
                    <div class="section-title">âš¡ æ€§èƒ½æŒ‡æ¨™</div>
                    <div class="info-panel">
                        <div class="info-label">å¹€ç‡ (FPS)</div>
                        <div class="info-value" id="fpsDisplay">0 FPS</div>
                    </div>
                </div>
                <div>
                    <div class="section-title">ğŸ’« ç³»çµ±ç‹€æ…‹</div>
                    <div class="info-panel">
                        <div class="info-label">ç‹€æ…‹</div>
                        <div class="info-value" id="systemStatus">åˆå§‹åŒ–ä¸­...</div>
                    </div>
                </div>
                <div>
                    <div class="section-title">ğŸ¯ æƒ…ç·’æƒæ</div>
                    <button class="btn" id="scanBtn" onclick="appState.startScan()" style="width: 100%;">é–‹å§‹æƒæ</button>
                    <div id="scanProgress" style="display: none; text-align: center;">
                        <div class="loading-spinner"></div>
                        <div style="margin-top: 10px; font-size: 14px;">æƒæä¸­... <span id="scanTime">3</span>s</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="results-screen" id="resultsScreen">
        <div class="results-content">
            <div class="emotion-icon" id="emotionIcon">ğŸ˜Š</div>
            <div class="emotion-name" id="emotionName">å¿«æ¨‚</div>
            <div class="emotion-desc" id="emotionDesc">æ‚¨å‘ˆç¾å‡ºç©æ¥µæ¨‚è§€çš„æƒ…ç·’ç‹€æ…‹ã€‚</div>
            <button class="btn" onclick="appState.closeResults()">ğŸ”„ é‡æ–°æƒæ</button>
        </div>
    </div>

    <script>
        // ============ å…¨å±€æ‡‰ç”¨ç‹€æ…‹ ============
        const appState = {
            scene: null,
            camera: null,
            renderer: null,
            maskModel: null,
            faceMesh: null,
            fps: 0,
            frameCount: 0,
            lastTime: Date.now(),
            isCameraActive: false,

            // ============ Three.js åˆå§‹åŒ– ============
            initThreeJS() {
                const container = document.getElementById('glContainer');
                
                // ç¢ºä¿å®¹å™¨æœ‰å°ºå¯¸
                const width = container.clientWidth;
                const height = container.clientHeight;
                
                if (width === 0 || height === 0) {
                    console.error('Container has zero dimensions');
                    return false;
                }

                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x000000);

                this.camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
                this.camera.position.z = 2;

                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
                this.renderer.setSize(width, height);
                this.renderer.setPixelRatio(window.devicePixelRatio || 1);
                
                container.appendChild(this.renderer.domElement);

                // å…‰æº
                const keyLight = new THREE.DirectionalLight(0xffffff, 1);
                keyLight.position.set(5, 5, 5);
                this.scene.add(keyLight);

                const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
                this.scene.add(ambientLight);

                // åŠ è¼‰æ¨¡å‹
                this.loadModel();

                // å•Ÿå‹•æ¸²æŸ“å¾ªç’°
                this.renderLoop();

                document.getElementById('systemStatus').textContent = 'âœ… Three.js å·²åˆå§‹åŒ–';
                return true;
            },

            // ============ åŠ è¼‰ GLB æ¨¡å‹ ============
            loadModel() {
                try {
                    const loader = new THREE.GLTFLoader();
                    loader.load(
                        './0_Monochrome_portrait_of_a_serious_man_Hunyuan_3D_a0e932ca(1).glb',
                        (gltf) => {
                            this.maskModel = gltf.scene;
                            this.maskModel.scale.set(1.5, 1.5, 1.5);
                            
                            this.maskModel.traverse((child) => {
                                if (child.isMesh) {
                                    child.material = new THREE.MeshStandardMaterial({
                                        color: 0xcccccc,
                                        metalness: 0.4,
                                        roughness: 0.6,
                                        emissive: 0x111111
                                    });
                                }
                            });
                            
                            this.scene.add(this.maskModel);
                            document.getElementById('systemStatus').textContent = 'âœ… 3D æ¨¡å‹å·²è¼‰å…¥';
                        },
                        undefined,
                        () => {
                            console.warn('GLB è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨çƒé«”');
                            this.useFallbackModel();
                        }
                    );
                } catch (error) {
                    console.error('æ¨¡å‹åŠ è¼‰éŒ¯èª¤:', error);
                    this.useFallbackModel();
                }
            },

            // ============ å‚™ç”¨æ¨¡å‹ ============
            useFallbackModel() {
                const geometry = new THREE.SphereGeometry(1, 32, 32);
                const material = new THREE.MeshStandardMaterial({
                    color: 0xcccccc,
                    metalness: 0.3,
                    roughness: 0.7
                });
                this.maskModel = new THREE.Mesh(geometry, material);
                this.scene.add(this.maskModel);
                document.getElementById('systemStatus').textContent = 'âš  ä½¿ç”¨çƒé«”æ¨¡å‹';
            },

            // ============ æ¸²æŸ“å¾ªç’° ============
            renderLoop() {
                requestAnimationFrame(() => this.renderLoop());
                
                if (this.renderer && this.scene && this.camera) {
                    this.renderer.render(this.scene, this.camera);
                }
                
                this.updateFPS();
            },

            // ============ åˆå§‹åŒ– Face Mesh ============
            async initFaceMesh() {
                this.faceMesh = new FaceMesh({
                    locateFile: (file) => 
                        `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
                });

                this.faceMesh.setOptions({
                    maxNumFaces: 1,
                    refineLandmarks: true,
                    minDetectionConfidence: 0.7,
                    minTrackingConfidence: 0.7
                });

                this.faceMesh.onResults((results) => this.onFaceMeshResults(results));
            },

            // ============ Face Mesh çµæœ ============
            onFaceMeshResults(results) {
                if (!results.multiFaceLandmarks || results.multiFaceLandmarks.length === 0) {
                    document.getElementById('landmarkCount').textContent = '0 / 468';
                    return;
                }

                const landmarks = results.multiFaceLandmarks[0];
                document.getElementById('landmarkCount').textContent = `${landmarks.length} / 468`;

                if (this.maskModel && landmarks.length > 0) {
                    const left = landmarks[33];
                    const right = landmarks[263];
                    const nose = landmarks[1];

                    const centerX = (left.x + right.x) / 2;
                    const centerY = (left.y + right.y) / 2;
                    const centerZ = (left.z + right.z) / 2;

                    this.maskModel.position.x = (centerX - 0.5) * 2;
                    this.maskModel.position.y = (0.5 - centerY) * 2;
                    this.maskModel.position.z = centerZ * -10;

                    const yaw = Math.atan2(nose.x - centerX, 0.05);
                    const pitch = (centerY - nose.y) * 100;
                    const roll = Math.atan2(right.y - left.y, right.x - left.x);

                    this.maskModel.rotation.x = pitch * (Math.PI / 180);
                    this.maskModel.rotation.y = yaw;
                    this.maskModel.rotation.z = roll;

                    const faceWidth = Math.abs(left.x - right.x);
                    const scale = faceWidth * 10;
                    const s = Math.max(0.5, Math.min(2, scale));
                    this.maskModel.scale.set(s, s, s);
                }
            },

            // ============ å•Ÿå‹•ç›¸æ©Ÿ ============
            async startCamera() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            width: { ideal: 1280 }, 
                            height: { ideal: 720 }, 
                            facingMode: 'user' 
                        },
                        audio: false
                    });

                    const video = document.getElementById('video');
                    video.srcObject = stream;
                    video.play();

                    await this.initFaceMesh();

                    const processFrame = async () => {
                        if (video.readyState === video.HAVE_ENOUGH_DATA) {
                            await this.faceMesh.send({ image: video });
                        }
                        requestAnimationFrame(processFrame);
                    };

                    processFrame();
                    this.isCameraActive = true;
                    document.getElementById('systemStatus').textContent = 'âœ… ç›¸æ©Ÿé‹è¡Œä¸­';
                } catch (error) {
                    console.error('ç›¸æ©ŸéŒ¯èª¤:', error);
                    document.getElementById('systemStatus').textContent = 'âŒ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—';
                }
            },

            // ============ æ›´æ–° FPS ============
            updateFPS() {
                this.frameCount++;
                const now = Date.now();
                const delta = (now - this.lastTime) / 1000;

                if (delta >= 1) {
                    this.fps = this.frameCount;
                    this.frameCount = 0;
                    this.lastTime = now;

                    document.getElementById('fpsCounter').textContent = `FPS: ${this.fps}`;
                    document.getElementById('fpsDisplay').textContent = `${this.fps} FPS`;
                }
            },

            // ============ æƒ…ç·’æƒæ ============
            startScan() {
                document.getElementById('scanBtn').style.display = 'none';
                document.getElementById('scanProgress').style.display = 'block';

                let time = 3;
                const timer = setInterval(() => {
                    document.getElementById('scanTime').textContent = time;
                    time--;
                    if (time < 0) {
                        clearInterval(timer);
                        this.completeScan();
                    }
                }, 1000);
            },

            completeScan() {
                const emotions = [
                    { name: 'å¿«æ¨‚', icon: 'ğŸ˜Š', desc: 'æ‚¨å‘ˆç¾å‡ºç©æ¥µæ¨‚è§€çš„æƒ…ç·’ç‹€æ…‹ã€‚' },
                    { name: 'å†·éœ', icon: 'ğŸ˜', desc: 'æ‚¨ä¿æŒè‘—ç©©å®šå¹³å’Œçš„å¿ƒå¢ƒã€‚' },
                    { name: 'å°ˆæ³¨', icon: 'ğŸ˜Œ', desc: 'æ‚¨å±•ç¾å‡ºæ·±å…¥æ€è€ƒçš„å°ˆæ³¨åŠ›ã€‚' },
                    { name: 'é©šè¨', icon: 'ğŸ˜²', desc: 'æ‚¨å°æŸäº›äº‹ç‰©è¡¨ç¾å‡ºæ–°é®®æ„Ÿã€‚' },
                    { name: 'æ”¾é¬†', icon: 'ğŸ˜Œ', desc: 'æ‚¨è¡¨ç¾å‡ºè¼•é¬†æ„œæ„çš„ç‹€æ…‹ã€‚' }
                ];

                const emotion = emotions[Math.floor(Math.random() * emotions.length)];
                document.getElementById('emotionIcon').textContent = emotion.icon;
                document.getElementById('emotionName').textContent = emotion.name;
                document.getElementById('emotionDesc').textContent = emotion.desc;
                document.getElementById('resultsScreen').classList.add('active');
                document.getElementById('scanProgress').style.display = 'none';
            },

            closeResults() {
                document.getElementById('resultsScreen').classList.remove('active');
                document.getElementById('scanBtn').style.display = 'block';
            }
        };

        // ============ åˆå§‹åŒ– ============
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                appState.initThreeJS();
            }, 100);
        });

        // ============ è¦–çª—èª¿æ•´ ============
        window.addEventListener('resize', () => {
            if (appState.renderer && appState.camera) {
                const container = document.getElementById('glContainer');
                const width = container.clientWidth;
                const height = container.clientHeight;
                
                appState.camera.aspect = width / height;
                appState.camera.updateProjectionMatrix();
                appState.renderer.setSize(width, height);
            }
        });
    </script>
</body>
</html>
