<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TENKI Debug Mode</title>
    
    <!-- 引入核心庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/DRACOLoader.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <style>
        body { background-color: #000; color: white; margin: 0; overflow: hidden; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        video { display: none; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: scaleX(-1); }
        
        /* 除錯訊息面板 */
        #debug-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 10px;
            font-family: monospace;
            font-size: 14px;
            z-index: 9999;
            display: none; /* 預設隱藏，有錯誤才顯示 */
            white-space: pre-wrap;
            word-break: break-all;
        }

        #status-log {
            position: fixed;
            top: 50px;
            left: 10px;
            color: #00f3ff;
            font-family: monospace;
            z-index: 9998;
            font-size: 12px;
            background: rgba(0,0,0,0.5);
            padding: 5px;
        }
    </style>
</head>
<body>

    <!-- 錯誤顯示區 -->
    <div id="debug-panel"></div>
    <div id="status-log">系統初始化中...</div>

    <video id="input-video" playsinline></video>
    <div id="canvas-container"></div>

    <script>
        // === 您的 GitHub 檔案絕對路徑 (CDN) ===
        // 這是最穩定的讀取方式，繞過相對路徑問題
        const MODEL_URL = 'https://cdn.jsdelivr.net/gh/Poshen100/tenki-emotion-app@main/models/3d-head.glb';

        const debugPanel = document.getElementById('debug-panel');
        const statusLog = document.getElementById('status-log');
        
        function log(msg) {
            console.log(msg);
            statusLog.innerText += '\n' + msg;
        }

        function showError(msg) {
            debugPanel.style.display = 'block';
            debugPanel.innerText = "❌ 錯誤: " + msg;
        }

        const videoElement = document.getElementById('input-video');
        const canvasContainer = document.getElementById('canvas-container');
        let scene, camera, renderer, faceMesh;
        let maskMesh = null; 

        function initThreeJS() {
            log("啟動 Three.js...");
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 2; 

            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            canvasContainer.appendChild(renderer.domElement);

            const ambientLight = new THREE.AmbientLight(0xffffff, 1.0);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 2.0);
            dirLight.position.set(1, 1, 2);
            scene.add(dirLight);

            // 嘗試載入模型
            loadFaceMask();
        }

        function loadFaceMask() {
            log("準備載入模型...");
            log("來源: " + MODEL_URL);

            const loader = new THREE.GLTFLoader();
            const dracoLoader = new THREE.DRACOLoader();
            dracoLoader.setDecoderPath('https://www.gstatic.com/draco/versioned/decoders/1.4.1/');
            loader.setDRACOLoader(dracoLoader);

            loader.load(
                MODEL_URL, 
                (gltf) => {
                    log("✅ 模型下載成功！解析中...");
                    maskMesh = gltf.scene;

                    // 材質處理
                    maskMesh.traverse((node) => {
                        if (node.isMesh) {
                            node.material = new THREE.MeshStandardMaterial({
                                color: 0xcccccc,
                                metalness: 0.5,
                                roughness: 0.5,
                                side: THREE.DoubleSide
                            });
                        }
                    });

                    maskMesh.scale.set(6, 6, 6);
                    scene.add(maskMesh);
                    log("✅ 模型已加入場景");
                }, 
                (xhr) => {
                    // 下載進度
                    if(xhr.lengthComputable) {
                        const percent = Math.round(xhr.loaded / xhr.total * 100);
                        statusLog.innerText = `下載進度: ${percent}%`;
                    }
                },
                (error) => {
                    // === 這裡是關鍵 ===
                    console.error(error);
                    
                    // 判斷錯誤類型
                    let errorMsg = error.message || "未知錯誤";
                    if (error.target && error.target.status) {
                        errorMsg = `HTTP ${error.target.status} (檔案找不到或被拒絕)`;
                    }
                    
                    showError(`載入失敗: ${errorMsg}\n請檢查 GitHub 檔名是否大小寫完全一致。`);
                    
                    // 只有失敗才顯示幾何球體
                    createPlaceholderMask();
                }
            );
        }

        function createPlaceholderMask() {
            log("⚠️ 使用備用球體");
            const geometry = new THREE.IcosahedronGeometry(1.0, 1);
            const material = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true });
            maskMesh = new THREE.Mesh(geometry, material);
            maskMesh.scale.set(1, 1.2, 1);
            scene.add(maskMesh);
        }

        // 簡化的 MediaPipe 初始化
        async function initFaceMesh() {
            log("啟動 FaceMesh...");
            const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
            
            faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
            faceMesh.onResults(onResults);

            const camera = new Camera(videoElement, {
                onFrame: async () => { await faceMesh.send({image: videoElement}); },
                width: 1280, height: 720
            });
            camera.start();
        }

        function onResults(results) {
            renderer.clear();
            renderer.render(scene, camera);
            
            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0 && maskMesh) {
                const landmarks = results.multiFaceLandmarks[0];
                const nose = landmarks[1];
                
                // 簡單定位
                const x = (0.5 - nose.x) * 4; 
                const y = (0.5 - nose.y) * 3;
                const z = -nose.z * 5; 
                maskMesh.position.set(x, y, 0);
            }
        }

        initThreeJS();
        initFaceMesh();
    </script>
</body>
</html>
