<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TENKI v19.0 - Aesthetic Flow</title>
    
    <!-- 核心引擎 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    
    <!-- UI 庫 -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- AESTHETIC UI 系統 --- */
        :root {
            --bg-deep: #050505;
            --primary: #4F46E5; /* Go Club 紫藍 */
            --accent: #00F0FF;  /* 發光青 */
            --glass: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.1);
            --card-gradient: linear-gradient(135deg, rgba(30, 30, 40, 0.9), rgba(20, 20, 25, 0.95));
        }

        body {
            background: var(--bg-deep);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif; /* 改回圓潤字體 */
            overflow: hidden;
            width: 100vw; height: 100vh;
            margin: 0; padding: 0;
        }

        /* 1. 絕對隱私 */
        #input-video {
            position: fixed; top: -9999px; left: -9999px;
            width: 1px; height: 1px; opacity: 0; pointer-events: none;
        }

        /* 2. 3D 星塵層 */
        #universe {
            position: absolute; inset: 0; z-index: 1;
            background: radial-gradient(circle at 50% 30%, #1a1f35 0%, #000000 80%);
            transition: filter 0.5s ease;
        }
        
        /* 模糊背景 (當結果頁出現時) */
        body.has-result #universe {
            filter: blur(20px) brightness(0.4);
        }

        /* 3. Apple-style 智能引導層 (Guidance) */
        #guidance-layer {
            position: absolute; inset: 0; z-index: 10;
            pointer-events: none;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }

        /* 智能光環 (The Ring) */
        .smart-ring {
            width: 280px; height: 350px;
            border-radius: 140px; /* 橢圓 */
            border: 2px solid rgba(255, 255, 255, 0.1);
            position: relative;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 0 0px rgba(255, 255, 255, 0);
        }

        /* 光環狀態：太遠 */
        .smart-ring.too-far {
            transform: scale(0.8);
            border-color: rgba(255, 255, 255, 0.3);
            border-style: dashed;
            animation: pulse-slow 2s infinite;
        }

        /* 光環狀態：偏移 (靠左/靠右) */
        .smart-ring.move-left { transform: translateX(-30px); border-right-color: var(--accent); }
        .smart-ring.move-right { transform: translateX(30px); border-left-color: var(--accent); }
        .smart-ring.move-up { transform: translateY(-30px); border-bottom-color: var(--accent); }
        .smart-ring.move-down { transform: translateY(30px); border-top-color: var(--accent); }

        /* 光環狀態：鎖定 (Locked) */
        .smart-ring.locked {
            transform: scale(1);
            border: 3px solid var(--accent);
            box-shadow: 0 0 40px var(--accent), inset 0 0 20px rgba(0, 240, 255, 0.2);
            background: rgba(0, 240, 255, 0.05);
        }

        /* 指紋按鈕 (Apple Pay 風格) */
        .scan-trigger-container {
            position: absolute; bottom: 60px; left: 0; width: 100%;
            display: flex; justify-content: center; pointer-events: none;
        }

        .fingerprint-btn {
            pointer-events: auto;
            width: 80px; height: 80px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            display: flex; justify-content: center; align-items: center;
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
            opacity: 0.5; transform: scale(0.9);
        }

        .smart-ring.locked ~ .scan-trigger-container .fingerprint-btn {
            opacity: 1; transform: scale(1);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 30px rgba(0, 240, 255, 0.3);
            cursor: pointer;
        }

        .fingerprint-btn.scanning {
            transform: scale(1.2);
            border-color: var(--accent);
            background: rgba(0, 240, 255, 0.2);
        }

        /* 4. Go Club 風格結果頁 (Result) */
        #result-layer {
            position: absolute; inset: 0; z-index: 50;
            display: flex; flex-direction: column; justify-content: flex-end;
            pointer-events: none; opacity: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 50%);
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            transform: translateY(20px);
        }

        #result-layer.show {
            opacity: 1; pointer-events: auto;
            transform: translateY(0);
            background: rgba(0,0,0,0.4); /* 全屏變暗 */
        }

        /* 卡片容器 */
        .cards-wrapper {
            padding: 24px;
            padding-bottom: 40px;
            display: flex; flex-direction: column; gap: 16px;
        }

        /* 主數據卡 (Hero Card) */
        .hero-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); /* 亮眼藍青漸層 */
            border-radius: 24px;
            padding: 24px;
            color: black;
            box-shadow: 0 20px 40px rgba(0, 242, 254, 0.2);
            position: relative; overflow: hidden;
        }
        
        .hero-card::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.4) 0%, transparent 60%);
            opacity: 0.5; pointer-events: none;
        }

        .hero-title { font-size: 14px; font-weight: 600; opacity: 0.7; letter-spacing: 0.5px; text-transform: uppercase; }
        .hero-value { font-size: 72px; font-weight: 800; letter-spacing: -2px; line-height: 1; margin: 10px 0; }
        .hero-subtitle { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 6px; }

        /* 次要卡片 (Grid) */
        .grid-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        
        .glass-card {
            background: rgba(30, 30, 35, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 16px;
            display: flex; flex-direction: column; justify-content: space-between;
            min-height: 120px;
        }

        .card-icon { 
            width: 36px; height: 36px; border-radius: 50%; 
            background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center;
            margin-bottom: 12px;
        }
        
        .stat-label { font-size: 12px; color: #888; margin-bottom: 4px; }
        .stat-value { font-size: 24px; font-weight: 700; color: white; }

        /* 再掃描按鈕 */
        .rescan-btn {
            background: white; color: black;
            border: none; border-radius: 50px;
            padding: 16px; font-weight: 700; font-size: 16px;
            width: 100%; margin-top: 10px;
            display: flex; justify-content: center; align-items: center; gap: 8px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            cursor: pointer; transition: transform 0.2s;
        }
        .rescan-btn:active { transform: scale(0.98); }

        /* 動畫 */
        @keyframes pulse-slow { 0% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 0.6; transform: scale(0.82); } 100% { opacity: 0.3; transform: scale(0.8); } }
        
        /* 隱藏元素 */
        .hidden { display: none !important; }

    </style>
</head>
<body>

    <video id="input-video" playsinline></video>

    <!-- 3D 背景 -->
    <div id="universe"></div>

    <!-- 智能引導層 (Guidance) -->
    <div id="guidance-layer">
        <div class="smart-ring" id="smart-ring">
            <!-- 這裡沒有文字，只有光圈 -->
        </div>
        
        <div class="scan-trigger-container">
            <div id="scan-trigger" class="fingerprint-btn">
                <i data-lucide="fingerprint" width="32" height="32" color="white"></i>
            </div>
        </div>
    </div>

    <!-- Go Club 風格結果層 -->
    <div id="result-layer">
        <div class="cards-wrapper">
            
            <!-- 大數據卡 -->
            <div class="hero-card">
                <div class="hero-title">Daily TEI Score</div>
                <div class="hero-value" id="final-score">00</div>
                <div class="hero-subtitle">
                    <i data-lucide="trending-up" width="16"></i> 
                    <span>Excellent Condition</span>
                </div>
            </div>

            <!-- 次要數據網格 -->
            <div class="grid-cards">
                <div class="glass-card">
                    <div class="card-icon" style="color: #FFD700;">
                        <i data-lucide="zap" width="18"></i>
                    </div>
                    <div>
                        <div class="stat-label">Energy</div>
                        <div class="stat-value">92%</div>
                    </div>
                </div>
                <div class="glass-card">
                    <div class="card-icon" style="color: #00F0FF;">
                        <i data-lucide="activity" width="18"></i>
                    </div>
                    <div>
                        <div class="stat-label">Focus</div>
                        <div class="stat-value">High</div>
                    </div>
                </div>
            </div>

            <!-- 再掃描按鈕 -->
            <button class="rescan-btn" onclick="app.reset()">
                <i data-lucide="rotate-ccw" width="18"></i>
                Rescan (2s)
            </button>
        </div>
    </div>

    <script>
        lucide.createIcons();

        const app = {
            config: { particleCount: 6000, particleSize: 0.08 }, // 稍微減少粒子數以提升手機效能
            state: { 
                isLocked: false, 
                isScanning: false, 
                mouthOpen: 0, 
                headRot: {x:0, y:0} 
            },

            init: function() {
                this.initThree();
                this.initAI();
                this.initEvents();
            },

            // --- 1. Three.js (Background) ---
            initThree: function() {
                const container = document.getElementById('universe');
                this.scene = new THREE.Scene();
                this.scene.fog = new THREE.FogExp2(0x050505, 0.02);

                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
                this.camera.position.z = 5;

                this.renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                container.appendChild(this.renderer.domElement);

                // 粒子系統
                const geometry = new THREE.BufferGeometry();
                const positions = [];
                const originals = [];
                
                for (let i = 0; i < this.config.particleCount; i++) {
                    // 球體分佈
                    const theta = Math.random() * Math.PI * 2;
                    const phi = Math.acos((Math.random() * 2) - 1);
                    const r = 2.5 + Math.random() * 0.5;

                    const x = r * Math.sin(phi) * Math.cos(theta);
                    const y = r * Math.sin(phi) * Math.sin(theta);
                    const z = r * Math.cos(phi);

                    positions.push(x, y, z);
                    originals.push(x, y, z);
                }

                geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
                geometry.setAttribute('original', new THREE.Float32BufferAttribute(originals, 3));

                // 圓形粒子材質
                const sprite = new THREE.TextureLoader().load('https://threejs.org/examples/textures/sprites/disc.png');
                this.material = new THREE.PointsMaterial({
                    size: this.config.particleSize,
                    map: sprite,
                    alphaTest: 0.5,
                    transparent: true,
                    opacity: 0.8,
                    color: 0x4F46E5 // 初始深藍
                });

                this.cloud = new THREE.Points(geometry, this.material);
                this.scene.add(this.cloud);
                this.animate();
            },

            animate: function() {
                requestAnimationFrame(() => this.animate());
                
                const time = Date.now() * 0.001;
                
                // 待機緩慢旋轉
                if (!this.state.isScanning) {
                    this.cloud.rotation.y += 0.001;
                    this.cloud.rotation.x += 0.0005;
                } else {
                    // 掃描時加速
                    this.cloud.rotation.y += 0.05;
                }

                // 頭部互動
                this.cloud.rotation.x += this.state.headRot.x * 0.05;
                this.cloud.rotation.y += this.state.headRot.y * 0.05;

                // 顏色呼吸
                if (this.state.isLocked) {
                    this.material.color.setHex(0x00F0FF); // 鎖定變青色
                } else {
                    this.material.color.setHex(0x4F46E5); // 待機深藍
                }

                this.renderer.render(this.scene, this.camera);
            },

            // --- 2. AI & Guidance Logic (The Apple Pay Style) ---
            initAI: function() {
                const video = document.getElementById('input-video');
                const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
                
                faceMesh.setOptions({
                    maxNumFaces: 1,
                    refineLandmarks: true,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });

                faceMesh.onResults((res) => this.updateGuidance(res));

                const camera = new Camera(video, {
                    onFrame: async () => await faceMesh.send({image: video}),
                    width: 640, height: 480
                });
                camera.start();
            },

            updateGuidance: function(results) {
                const ring = document.getElementById('smart-ring');
                
                if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                    const landmarks = results.multiFaceLandmarks[0];
                    const nose = landmarks[1]; // 鼻頭
                    const leftEye = landmarks[33];
                    const rightEye = landmarks[263];
                    
                    // 計算臉部大小 (距離)
                    const faceWidth = Math.abs(leftEye.x - rightEye.x);
                    
                    // 重置 Class
                    ring.className = 'smart-ring'; 

                    // 1. 距離判斷 (太遠/太近)
                    if (faceWidth < 0.15) {
                        ring.classList.add('too-far'); // 光圈變小、虛線
                        this.state.isLocked = false;
                        return;
                    }

                    // 2. 位置判斷 (偏移) - 這是引導核心
                    // 0.5 是中心點
                    const centerX = 0.5; 
                    const centerY = 0.5;
                    const tolerance = 0.1; // 容許誤差

                    let isCentered = true;

                    if (nose.x < centerX - tolerance) {
                        ring.classList.add('move-left'); // 提示往左
                        isCentered = false;
                    } else if (nose.x > centerX + tolerance) {
                        ring.classList.add('move-right'); // 提示往右
                        isCentered = false;
                    }

                    if (nose.y < centerY - tolerance) {
                        ring.classList.add('move-up');
                        isCentered = false;
                    } else if (nose.y > centerY + tolerance) {
                        ring.classList.add('move-down');
                        isCentered = false;
                    }

                    // 3. 鎖定判斷
                    if (isCentered) {
                        ring.classList.add('locked'); // 變實線、發光、變色
                        this.state.isLocked = true;
                        
                        // 更新頭部轉動數據給 3D
                        this.state.headRot.x = (nose.y - 0.5) * 2;
                        this.state.headRot.y = (nose.x - 0.5) * 2;
                    } else {
                        this.state.isLocked = false;
                    }

                } else {
                    // 沒人臉
                    ring.className = 'smart-ring too-far';
                    this.state.isLocked = false;
                }
            },

            // --- 3. Interaction & Flow ---
            initEvents: function() {
                const btn = document.getElementById('scan-trigger');
                
                const startScan = (e) => {
                    e.preventDefault();
                    if (!this.state.isLocked) return; // 沒鎖定不能按

                    this.state.isScanning = true;
                    btn.classList.add('scanning');
                    
                    if (navigator.vibrate) navigator.vibrate(50);

                    // 2秒後完成
                    setTimeout(() => {
                        this.finishScan();
                    }, 2000);
                };

                btn.addEventListener('mousedown', startScan);
                btn.addEventListener('touchstart', startScan);
            },

            finishScan: function() {
                this.state.isScanning = false;
                document.getElementById('scan-trigger').classList.remove('scanning');
                if (navigator.vibrate) navigator.vibrate([50, 50]);

                // 顯示結果
                this.showResult();
            },

            showResult: function() {
                document.body.classList.add('has-result');
                document.getElementById('guidance-layer').style.opacity = 0; // 隱藏掃描UI
                document.getElementById('result-layer').classList.add('show');

                // 跑分動畫
                const scoreEl = document.getElementById('final-score');
                let score = 0;
                const target = Math.floor(Math.random() * (98 - 85) + 85); // 隨機高分
                
                const timer = setInterval(() => {
                    score += 4;
                    if (score >= target) {
                        score = target;
                        clearInterval(timer);
                    }
                    scoreEl.innerText = score;
                }, 30);
            },

            reset: function() {
                document.body.classList.remove('has-result');
                document.getElementById('result-layer').classList.remove('show');
                
                // 延遲一下顯示掃描UI，讓轉場更順
                setTimeout(() => {
                    document.getElementById('guidance-layer').style.opacity = 1;
                }, 300);
            }
        };

        window.onload = () => app.init();
        window.onresize = () => {
            app.camera.aspect = window.innerWidth / window.innerHeight;
            app.camera.updateProjectionMatrix();
            app.renderer.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>
